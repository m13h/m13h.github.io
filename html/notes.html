<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-11-23 ma. 11:39 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Notes from CTF tasks (math/programming-related)</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="franksh" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="styles/readtheorg/css/readtheorg.css"/>
<script type="text/javascript" src="styles/lib/js/jquery.min.js"></script>
<script type="text/javascript" src="styles/lib/js/bootstrap.min.js"></script>
<script type="text/javascript" src="styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="styles/readtheorg/js/readtheorg.js"></script>
<style>pre.src{background:#1f1f10;color:white;} .footref{font-size: 100%;} p{font-size: 110%;}</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Notes from CTF tasks (math/programming-related)</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org4a5ec17">About</a></li>
<li><a href="#orga29648a">N1CTF2020</a>
<ul>
<li><a href="#org7f61fc5">General Comments</a></li>
<li><a href="#org4748b17">crypto:VSS</a></li>
<li><a href="#org9c085dc">crypto:FlagBot</a></li>
<li><a href="#org38b8ed9">crypto:curve</a></li>
<li><a href="#org5f5158c">crypto:easy RSA?</a></li>
<li><a href="#org9744b57">crypto:babyProof</a></li>
</ul>
</li>
<li><a href="#orgca95166">Hack.lu 2020</a>
<ul>
<li><a href="#org2f3d43f">General Comments</a></li>
<li><a href="#orgf0228cb">crypto:Bad Primes</a></li>
<li><a href="#org6de9b29">misc:BabyJS</a></li>
<li><a href="#org04ab205">crypto:Conquering Premium Access</a></li>
<li><a href="#org89eaf2b">misc:P*rn Protocol</a></li>
<li><a href="#org01f41cd">crypto:Pwnhub Collection</a></li>
</ul>
</li>
<li><a href="#orgcd851c6">CyberSecurityRumble 2020</a>
<ul>
<li><a href="#orgc866158">General Comments</a></li>
<li><a href="#org2023a3d">crypto:Pady McPadface</a></li>
<li><a href="#org921c43e">crypto:dlog</a></li>
<li><a href="#org6341570">crypto:ezdsa</a></li>
<li><a href="#orga4e13c9">misc:Pylindrome</a></li>
<li><a href="#org2614d67">baby:Hashfun</a></li>
<li><a href="#orgb023fb6">crypto:dtls</a></li>
<li><a href="#org32f0d87">web:Yanote</a></li>
</ul>
</li>
<li><a href="#org2466d88">BalsnCTF 2020</a>
<ul>
<li><a href="#balsn2020">General Comments</a></li>
<li><a href="#org5285b32">Happy Farm</a>
<ul>
<li><a href="#orgd072804">Task 1: AES CBC</a></li>
<li><a href="#org79f10b0">Task 2: RSA and Euler hacks</a></li>
<li><a href="#org672dcfb">Task 3: Borked RCA</a></li>
</ul>
</li>
<li><a href="#org68f9025">The Last Bitcoin</a></li>
<li><a href="#org4231ac6">The Danger of Google's Omnipotence</a></li>
<li><a href="#orgd28210c">aeshash &amp; IEAIE &amp; Patience I</a></li>
<li><a href="#org138ec7b">babyrev</a></li>
</ul>
</li>
<li><a href="#org950d79a">DragonCTF 2020</a>
<ul>
<li><a href="#dragon2020">General Comments</a></li>
<li><a href="#org5b5da77">Frying in motion</a></li>
<li><a href="#org2733f80">Bit Flip 1</a></li>
<li><a href="#org6db8c77">babykok</a></li>
<li><a href="#orgd34d048">Bit Flip 2 &amp; 3</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org4a5ec17" class="outline-2">
<h2 id="org4a5ec17">About</h2>
<div class="outline-text-2" id="text-org4a5ec17">
<p>
<b>Who:</b> <code>tope</code> of <code>mode13h</code> (two-man team from Norway)
</p>

<p>
<b>Contact:</b> <code>tope#9134@Discord</code> (I am friendly to the point of being flirtatious,
so feel free to message me)
</p>

<p>
<b>Audience:</b> I am writing these notes to some imagined fellow CTFer who looked at
the same tasks that I did, but missed some critical step for the solve, or
perhaps someone who did solve them and just wants to compare notes. I'll rarely
re-post the full problem as given in the CTF, nor do very detailed expositions.
For the time being this isn't intended as a pedagogical resource. The target
audience ("you") are not complete beginners, <i>some</i> facility with math is
assumed.
</p>

<p>
<b>Content:</b> My favorite tasks are of the "puzzle"<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup> variety. In CTFs these
would normally be found under misc and crypto. My safe space is the intersection
between programming and mathematics.
</p>

<p>
<b>Motivation:</b> I am fascinated by the generalities behind puzzles&#x2013;i.e. their
mathematical expression&#x2013;and I love solving problems with programming.
Fascination gives off a glow, and this glow-energy is what I'd like to call
motivation. The competitive element of CTFs has little bearing, and I tend to
avoid CTFs with uninteresting problems.
</p>
</div>
</div>

<div id="outline-container-orga29648a" class="outline-2">
<h2 id="orga29648a">N1CTF2020</h2>
<div class="outline-text-2" id="text-orga29648a">
</div>
<div id="outline-container-org7f61fc5" class="outline-3">
<h3 id="org7f61fc5">General Comments</h3>
<div class="outline-text-3" id="text-org7f61fc5">
<p>
An <b>A+</b> CTF! An <i>incredible</i> amount of tasks, from mid-tier to top-tier
difficulty level. Objectively the task set alone deserves a ~100 rating on
CTFTime<sup><a id="fnr.3" class="footref" href="#fn.3">3</a></sup>.
</p>

<p>
I did the crypto tasks and will outline solves for those below. I also glanced at some of the
"easier" tasks in misc and web, but even the entry-level tasks in those
categories were beyond me.
</p>

<p>
<i>Personal downside #1</i>: very biased toward web, rev, and pwn, which I am pretty
clueless about, though those are the "true" staples of CTF. I realize this is
more like a pure upside for most people.
</p>

<p>
On the end of the first day there were only three crypto tasks released yet more
than fifteen(!?) web, pwn, and rev tasks out. I sat around twiddling my thumbs a
bit, feeling pretty useless.
</p>

<p>
The only misc-like task I saw involved PHP, which is more of a mental plague
than a programming language<sup><a id="fnr.4" class="footref" href="#fn.4">4</a></sup>. I played around with it a bit, but finally
just went to bed feeling a little bit dumber and somewhat frustrated because I
thought all tasks had been released and that I'd be useless for the rest of the
CTF.
</p>

<p>
<i>Personal downside #2</i>: Two more crypto were released just after I'd gone to
sleep on day two, so I only had a few hours for them when I woke up. Although
the new tasks were a nice surprise, the timing was very unfortunate for me.
</p>

<p>
<i>Plea for organizers in general: please consider having all tasks out by the
mid-way point of the CTF.</i> If not, then communicate your planned task release
schedule so it's possible to better manage our time?
</p>

<p>
We ended up placing 13th<sup><a id="fnr.5" class="footref" href="#fn.5">5</a></sup>.
</p>
</div>
</div>

<div id="outline-container-org4748b17" class="outline-3">
<h3 id="org4748b17">crypto:VSS</h3>
<div class="outline-text-3" id="text-org4748b17">
<p>
You're given some code which generates a QR-code image of the flag and uses that
image to create two new randomized images which&#x2013;when combined&#x2013;would
reconstruct the original (albeit transposed? I am guessing, I didn't actually
run the code). You also receive <i>one</i> of the images generated. It struck me as a
little cryptic.
</p>

<p>
I ignored the whole visual threshold part of the task and noted it uses Python's
random module to generate the pixels in the output images. That's a lot of
random data, and the QR-code image it's based on has a lot of known fixed
output. After double-checking that the QR-image had enough known pixels (you get
to reverse one bit of state per pixel) and where it was (it would be hell if it
wasn't contiguous), it reduces to a "standard" reverse-the-RNG-state task.
</p>

<p>
For the reversing Python's MT the <i>easy</i> way you need \(32 \cdot 672\) contiguous
bits of output. That is if you don't have to worry about missing state. You need
to undo the tempering that MT does to its output words:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #7d7c61; font-weight: bold;">def</span> <span style="color: #9b55c3;">untemper</span><span style="color: #bdbdb3;">(</span>x<span style="color: #bdbdb3;">)</span>:
  <span style="color: #fb8512;">x</span> ^= <span style="color: #bdbdb3;">(</span>x &gt;&gt; <span style="color: #6a7550;">18</span><span style="color: #bdbdb3;">)</span>
  <span style="color: #fb8512;">x</span> ^= <span style="color: #bdbdb3;">(</span>x &lt;&lt; <span style="color: #6a7550;">15</span><span style="color: #bdbdb3;">)</span> &amp; <span style="color: #6a7550;">0xefc60000</span>
  <span style="color: #fb8512;">x</span> ^= <span style="color: #bdbdb3;">(</span><span style="color: #6a9550;">(</span>x &lt;&lt; <span style="color: #6a7550;">7</span><span style="color: #6a9550;">)</span> &amp; <span style="color: #6a7550;">0x9d2c5680</span><span style="color: #bdbdb3;">)</span> ^ <span style="color: #bdbdb3;">(</span><span style="color: #6a9550;">(</span>x &lt;&lt; <span style="color: #6a7550;">14</span><span style="color: #6a9550;">)</span> &amp; <span style="color: #6a7550;">0x94284000</span><span style="color: #bdbdb3;">)</span> ^ <span style="color: #bdbdb3;">(</span><span style="color: #6a9550;">(</span>x &lt;&lt; <span style="color: #6a7550;">21</span><span style="color: #6a9550;">)</span> &amp; <span style="color: #6a7550;">0x14200000</span><span style="color: #bdbdb3;">)</span> ^ <span style="color: #bdbdb3;">(</span><span style="color: #6a9550;">(</span>x &lt;&lt; <span style="color: #6a7550;">28</span><span style="color: #6a9550;">)</span> &amp; <span style="color: #6a7550;">0x10000000</span><span style="color: #bdbdb3;">)</span>
  <span style="color: #fb8512;">x</span> ^= <span style="color: #bdbdb3;">(</span>x &gt;&gt; <span style="color: #6a7550;">11</span><span style="color: #bdbdb3;">)</span> ^ <span style="color: #bdbdb3;">(</span>x &gt;&gt; <span style="color: #6a7550;">22</span><span style="color: #bdbdb3;">)</span>
  <span style="color: #7d7c61; font-weight: bold;">return</span> x
</pre>
</div>

<p>
You combine words <code>i</code>, <code>i+1</code>, and <code>i+M</code> to get word <code>i+N</code>:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #fb8512;">tmp</span> = w<span style="color: #bdbdb3;">[</span>i<span style="color: #bdbdb3;">][</span><span style="color: #6a7550;">31</span><span style="color: #bdbdb3;">]</span> ^ w<span style="color: #bdbdb3;">[</span>i+<span style="color: #6a7550;">1</span><span style="color: #bdbdb3;">][</span>:<span style="color: #6a7550;">31</span><span style="color: #bdbdb3;">]</span>  <span style="color: #6abd50;"># </span><span style="color: #6aaf50;">using slice notation to select bits</span>
<span style="color: #fb8512;">w</span><span style="color: #bdbdb3;">[</span>i+N<span style="color: #bdbdb3;">]</span> = tmp&gt;&gt;<span style="color: #6a7550;">1</span> ^ w<span style="color: #bdbdb3;">[</span>i+M<span style="color: #bdbdb3;">]</span> ^ <span style="color: #bdbdb3;">(</span>A <span style="color: #7d7c61; font-weight: bold;">if</span> tmp<span style="color: #6a9550;">[</span><span style="color: #6a7550;">0</span><span style="color: #6a9550;">]</span> <span style="color: #7d7c61; font-weight: bold;">else</span> <span style="color: #6a7550;">0</span><span style="color: #bdbdb3;">)</span>
</pre>
</div>

<p>
<code>M</code>, <code>N</code>, <code>A</code> are constants from <code>_randommodule.c</code> in CPython source code. Then
you reapply the tempering (see aforementioned <code>.c</code> source) and it should match
Python's output. That's the basic idea.
</p>

<p>
It was a task which is very easy to realize the solution but rather painful to
implement. I struggled with infinite little indexing bugs. The headache I got
from trying to directly indexing into <code>bin(random.getrandbits(...))</code> was not
worth it. (Bits within words run from bit \(2^{31}\) to \(1\), but the words are in
little-endian order.) I even had bugs in the final solution as some randomness
was leaking through, but fortunately QR-codes are highly redundant, so I didn't
care. Then again I probably did things needlessly complicated by
reverse-generating the original QR-code instead of simply generating the
"companion" image to the one shared.
</p>

<p>
Apart from headaches it gave me with my own bugs, it's actually a fairly clever
task, because there aren't any obvious "hints" that points you in the right
direction, so it might take a while to notice. I was pretty lucky.
</p>
</div>
</div>

<div id="outline-container-org9c085dc" class="outline-3">
<h3 id="org9c085dc">crypto:FlagBot</h3>
<div class="outline-text-3" id="text-org9c085dc">
<p>
Several random 256-bit elliptic curves are generated and used to do a standard
key exchange to AES-encrypt the flag. The curves are all asserted to be
non-smooth and resistant to MOV attack. You get the public output of the
exchanges as well as the encrypted messages. It's a very nice and clean task
with a likewise straightforward implementation. It was a pure blessing after the
indexical spaghetti that was VSS.
</p>

<p>
The key to realize is that the secret is reused (for both client and server).
The generated random curves have a lot of small random subgroups, so you can
solve the discrete log in those subgroups (multiply the generator and public
keys by \((p-1)/q\) to put it in the subgroup of size \(q\)), get constraints like
\(secret = x_i \pmod{q_i}\), and then do Chinese Remainder when you have enough. A
partial Pohlig-Hellman, if you will.
</p>

<p>
I think I did most of this task in REPL, but the pseudo-code sketch would be:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #fb8512;">crt_r</span>, <span style="color: #fb8512;">crt_s</span> = <span style="color: #bdbdb3;">[]</span>, <span style="color: #bdbdb3;">[]</span>
<span style="color: #7d7c61; font-weight: bold;">for</span> ec,pk_r,pk_s <span style="color: #7d7c61; font-weight: bold;">in</span> data:
  <span style="color: #fb8512;">order</span> = ec.order<span style="color: #bdbdb3;">()</span>
  <span style="color: #7d7c61; font-weight: bold;">for</span> f <span style="color: #7d7c61; font-weight: bold;">in</span> small_factors<span style="color: #bdbdb3;">(</span>order<span style="color: #bdbdb3;">)</span>:
    crt_r.append<span style="color: #bdbdb3;">(</span> <span style="color: #6a9550;">(</span>babystepgiantstep<span style="color: #baba36;">(</span>f, pk_r*<span style="color: #9b55c3;">(</span>order/f<span style="color: #9b55c3;">)</span>, g*<span style="color: #9b55c3;">(</span>order/f<span style="color: #9b55c3;">)</span><span style="color: #baba36;">)</span>, f<span style="color: #6a9550;">)</span> <span style="color: #bdbdb3;">)</span>
    crt_s.append<span style="color: #bdbdb3;">(</span> <span style="color: #6a9550;">(</span>babystepgiantstep<span style="color: #baba36;">(</span>f, pk_s*<span style="color: #9b55c3;">(</span>order/f<span style="color: #9b55c3;">)</span>, g*<span style="color: #9b55c3;">(</span>order/f<span style="color: #9b55c3;">)</span><span style="color: #baba36;">)</span>, f<span style="color: #6a9550;">)</span> <span style="color: #bdbdb3;">)</span>

<span style="color: #fb8512;">r</span>,<span style="color: #fb8512;">s</span> = crt<span style="color: #bdbdb3;">(</span>*crt_r<span style="color: #bdbdb3;">)[</span><span style="color: #6a7550;">0</span><span style="color: #bdbdb3;">]</span>, crt<span style="color: #bdbdb3;">(</span>*crt_s<span style="color: #bdbdb3;">)[</span><span style="color: #6a7550;">0</span><span style="color: #bdbdb3;">]</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org38b8ed9" class="outline-3">
<h3 id="org38b8ed9">crypto:curve</h3>
<div class="outline-text-3" id="text-org38b8ed9">
<p>
In this task (against a live server) you're asked for elliptic curve parameters
\((p, a, b)\) and two points \((G_1, G_2)\) and then have to solve 30 rounds of
distinguishing \(G_1 \cdot r \cdot s\) from \(G_1 \cdot x\) when given \(G_1 \cdot r\)
and \(G_2 \cdot s\) (for random secret integers \(r, s, x\)). It will throw an
exception if you give it a singular curve or points not on the curve.
</p>

<p>
At first glance I thought this was too similar to <code>FlagBot</code>, because there are
no checks against the points being in a small subgroup. I knew you could also
use trace 1 curves on which the much-copy-pasted Smart attack works, but I only
have that code in some Sage docker; I wanted to use my own comfortable code and
homemade Python libraries. Besides, <i>I got this</i>: I thought it would just be a
matter of trivially putting them into small subgroups and solving the CRT again.
A bit too easy, maybe&#x2026;
</p>

<p>
Yeah, after a while I realized my oops: it required a very <i>large</i> prime modulus
\(p\) and calls <code>E.order()</code> on the curve &#x2013; <i>and</i> there's a timer on the program.
The <code>E.order()</code> call takes well over a minute, sometimes several minutes, and so
there's no time to do the loop. I wasted some time trying to find random curves for
which <code>E.order()</code> was smooth or took less time but&#x2026;
</p>

<p>
Finally I relented and tested <code>E.order()</code> on a curve with \(|E_p| = p\). It was
instant, of course, so&#x2026; <i>sigh</i> Copy-pasted Sage code it is, then.
</p>

<p>
Now the problem was to generate curves with trace 1, which I didn't know how to
do, but <code>poiko</code> talked of a DEFCON task which had involved generating such
curves and gave me a paper: <a href="http://www.monnerat.info/publications/anomalous.pdf">http://www.monnerat.info/publications/anomalous.pdf</a>
</p>

<p>
From the paper I figured I wanted curves under primes \(p = 11 m (m+1) + 3\) with
\((a,b)\) which gives j-invariant equal to \(-2^{15}\), I quickly found plenty such
curves. Then copy-paste <code>Smart_Attack()</code> and blah, blah, the usual stuff. (I
really despise copy-pasting.) A bit unrewarding due to my stubbornness, but I
have to admit it was a good task in the end, even if the "hidden" constraint of
"the given curve must also have a fast <code>E.order()</code>" was a bit devious<sup><a id="fnr.6" class="footref" href="#fn.6">6</a></sup>.
</p>
</div>
</div>

<div id="outline-container-org5f5158c" class="outline-3">
<h3 id="org5f5158c">crypto:easy RSA?</h3>
<div class="outline-text-3" id="text-org5f5158c">
<p>
A fun task which had two stages.
</p>

<p>
It generates some RSA-modulus \(n = p*q\) and encrypts a large vector with lots of
numbers. These numbers are the vector (dot) products between the flag and random
numbers, offset by some small error, and then modulo a small prime. You are
given the random numbers used for free, but the errors are secret.
</p>

<p>
The primes are generated in a truly bizarre way:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #fb8512;">mark</span> = <span style="color: #6a7550;">3</span>**<span style="color: #6a7550;">66</span>
<span style="color: #7d7c61; font-weight: bold;">def</span> <span style="color: #9b55c3;">get_random_prime</span><span style="color: #bdbdb3;">()</span>:
  <span style="color: #fb8512;">total</span> = <span style="color: #6a7550;">0</span>
  <span style="color: #7d7c61; font-weight: bold;">for</span> i <span style="color: #7d7c61; font-weight: bold;">in</span> <span style="color: #bdbdb3; font-weight: bold;">range</span><span style="color: #bdbdb3;">(</span><span style="color: #6a7550;">5</span><span style="color: #bdbdb3;">)</span>:
    <span style="color: #fb8512;">total</span> += mark**i * getRandomNBitInteger<span style="color: #bdbdb3;">(</span><span style="color: #6a7550;">32</span><span style="color: #bdbdb3;">)</span>
  <span style="color: #fb8512;">fac</span> = <span style="color: #bdbdb3; font-weight: bold;">str</span><span style="color: #bdbdb3;">(</span>factor<span style="color: #6a9550;">(</span>total<span style="color: #6a9550;">)</span><span style="color: #bdbdb3;">)</span>.split<span style="color: #bdbdb3;">(</span><span style="color: #CC5542;">" * "</span><span style="color: #bdbdb3;">)</span>
  <span style="color: #7d7c61; font-weight: bold;">return</span> <span style="color: #bdbdb3; font-weight: bold;">int</span><span style="color: #bdbdb3;">(</span>fac<span style="color: #6a9550;">[</span>-<span style="color: #6a7550;">1</span><span style="color: #6a9550;">]</span><span style="color: #bdbdb3;">)</span>
</pre>
</div>

<p>
It generates a number that has "small" digits in base-\(3^{66}\) and returns the
largest prime in the factorization of this number. That's one of the oddest ways
to generate primes I've seen.
</p>

<p>
But (the "a-ha" moment) it means that \(n\cdot x\) also has "small" digits in
base-\(3^{66}\) for some \(x\) which is itself also "small" (compared to \(n\)).
</p>

<p>
I used a lattice like
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #bdbdb3;">[</span>   n * HH, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">1</span><span style="color: #bdbdb3;">]</span>,
<span style="color: #bdbdb3;">[</span>   <span style="color: #6a7550;">1</span> * HH, HL, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span><span style="color: #bdbdb3;">]</span>,
<span style="color: #bdbdb3;">[</span>B**<span style="color: #6a7550;">1</span> * HH, <span style="color: #6a7550;">0</span>, HL, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span><span style="color: #bdbdb3;">]</span>,
<span style="color: #bdbdb3;">[</span>B**<span style="color: #6a7550;">2</span> * HH, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, HL, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span><span style="color: #bdbdb3;">]</span>,
<span style="color: #bdbdb3;">[</span>B**<span style="color: #6a7550;">3</span> * HH, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, HL, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span><span style="color: #bdbdb3;">]</span>,
<span style="color: #bdbdb3;">[</span>B**<span style="color: #6a7550;">4</span> * HH, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, HL, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span><span style="color: #bdbdb3;">]</span>,
<span style="color: #bdbdb3;">[</span>B**<span style="color: #6a7550;">5</span> * HH, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, HL, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span><span style="color: #bdbdb3;">]</span>,
<span style="color: #bdbdb3;">[</span>B**<span style="color: #6a7550;">6</span> * HH, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, HL, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span><span style="color: #bdbdb3;">]</span>,
<span style="color: #bdbdb3;">[</span>B**<span style="color: #6a7550;">7</span> * HH, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, HL, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span><span style="color: #bdbdb3;">]</span>,
<span style="color: #bdbdb3;">[</span>B**<span style="color: #6a7550;">8</span> * HH, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, HL, <span style="color: #6a7550;">0</span><span style="color: #bdbdb3;">]</span>,
</pre>
</div>

<p>
to find \(x\). There might be better ways, but it worked. Now to factor. Trivially
you can find the first and last digits of the primes. There's probably some more
clever way to do the whole thing, but I just did the dumb thing and used the
base-\(B\) digits of \(n\cdot x\) as coefficients for a polynomial over \(\mathbb{Z}_p\)
for some large \(p\) and factored that. That gave me two numbers back (when
multiplied so the least/most significant digits match), each of which shared one
of the big primes with \(n\). This was all a bit rushed because it took me too
long to discover the "trick" of finding \(n \cdot x\) and I just did everything in
the REPL at this point, using my own utility libraries and NTL wrapper.
</p>

<p>
So now I had \(n = p \cdot q\) and could decrypt the vector to get a big system of linear
relations with "small errors" modulo some small prime. The lattice is life, the
lattice is love. Maybe there's a more clever way to solve this as well, but did
I mention I was a little pressed for time at this point? The system in its
entirely was too big for my poor, slow LLL, but a small random subset of
equations worked just fine (every equation involved the entire flag).
</p>
</div>
</div>

<div id="outline-container-org9744b57" class="outline-3">
<h3 id="org9744b57">crypto:babyProof</h3>
<div class="outline-text-3" id="text-org9744b57">
<p>
I "solved" this task but was a little too late. I had already realized the
solution by the last hour or two, but underestimated how many datasets I needed
and wasted some time with self-doubt, double-checking, and massaging
uncooperative lattices. When the competition ended I went to eat and by the time
I got back there was enough data and I got the (bittersweet) flag easily.
</p>

<p>
Like <code>FlagBot</code> it's a deceptively clean and simple task, where you don't realize
the problem until that sweet "a-ha!" moment. The server uses generated DSA
constants (a (huge) prime \(p\), a generator \(g\) for a large prime (\(q\)) subgroup
of \(\mathbb{Z}_p\)) to prove that it knows \(x\) in \(y=g^x \pmod p\) by giving you
\(y\), \(t=y^v \pmod p\) (for some secret ephemeral key \(v\)) and \(r = v - c \cdot x
 \pmod q\) with \(c\) being a SHA256 constant the recepient can derive from \((g, y,
 t)\). It looks respectable and above the board at first glance&#x2026;
</p>

<p>
But basically you need to forget everything I just said and ignore the whole
business with \(p\) and discrete logs. With \(r\) you're given a system of
inequalities like \(c_i \cdot flag + r_i < flag \pmod{q_i}\), because the ephemeral
key is erroneously generated to be less than \(x\) which was asserted to be 247
bits in the code (while \(q\) is 256 bits), so each equation ought to reveal a
little bit more about \(x\). It is clearly another lattice problem.
</p>

<p>
I'm not sure if there are any better or more clever ways to set up the lattice,
but what worked for me in the end was the most obvious and straightforward:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #bdbdb3;">[</span><span style="color: #6a9550;">[</span><span style="color: #6a7550;">1</span>,     <span style="color: #6a7550;">0</span>, c0, c1, ...,  cn<span style="color: #6a9550;">]</span>,
 <span style="color: #6a9550;">[</span><span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">2</span>^<span style="color: #6a7550;">248</span>, r0, r2, ...,  rn<span style="color: #6a9550;">]</span>,
 <span style="color: #6a9550;">[</span><span style="color: #6a7550;">0</span>,     <span style="color: #6a7550;">0</span>, q0,  <span style="color: #6a7550;">0</span>, ...,   <span style="color: #6a7550;">0</span><span style="color: #6a9550;">]</span>
 <span style="color: #6a9550;">[</span><span style="color: #6a7550;">0</span>,     <span style="color: #6a7550;">0</span>,  <span style="color: #6a7550;">0</span>, q1, ...,   <span style="color: #6a7550;">0</span><span style="color: #6a9550;">]</span>
 <span style="color: #6a9550;">[</span><span style="color: #6a7550;">0</span>,     <span style="color: #6a7550;">0</span>,  <span style="color: #6a7550;">0</span>,  <span style="color: #6a7550;">0</span>, ...,  qn<span style="color: #6a9550;">]</span><span style="color: #bdbdb3;">]</span>
</pre>
</div>

<p>
<code>b'n1ctf{S0me_kn0wl3dg3_is_leak3d}'</code> Since I can no longer enter it on the site,
I'll leave it here to be sad and alone. :(
</p>
</div>
</div>
</div>

<div id="outline-container-orgca95166" class="outline-2">
<h2 id="orgca95166">Hack.lu 2020</h2>
<div class="outline-text-2" id="text-orgca95166">
</div>
<div id="outline-container-org2f3d43f" class="outline-3">
<h3 id="org2f3d43f">General Comments</h3>
<div class="outline-text-3" id="text-org2f3d43f">
<p>
An unfortunate step down from last weekend's <a href="n1ctf2020.html">N1CTF2020</a> even though this one has
a much higher rating on <code>CTFTime</code>.
</p>

<p>
<b>DISCLAIMER:</b> I'm judging with very biased goggles here; I'm sure web/rev/pwn
were all kinds of excellent and top notch woo-hoo, but misc and crypto was very
disappointing and demotivating for this rating bracket and I tapped out early.
It felt too easy and/or uninspired and/or unoriginal.
</p>

<p>
I am also going to sound <i>incredibly</i> negative. It wasn't that bad, but it
definitely wasn't a 100-point CTF, and that's the stance I'm critiquing from.
The tasks I looked at felt like they belonged in the 50-70 range.
</p>

<p>
<a href="#org01f41cd">crypto:Pwnhub Collection</a> which was (unnecessarily) gated behind rev would probably be
my pick for "best" crypto-task, because it actively combines two related
techniques in a sensible way. <a href="#org04ab205">crypto:Conquering Premium Access</a> had a copy-pastable
solution through Google, which was not fun to discover. <a href="#org2ee69c1">crypto:Bad Primes</a> was somewhat
trivial<sup><a id="fnr.7" class="footref" href="#fn.7">7</a></sup>. <a href="#org6de9b29">misc:BabyJS</a> was cute but that's about it. More info about them
below. (As usual I will just outline the solves, these are just notes that should allow
anyone who attempted or failed the problems to solve them.)
</p>
</div>
</div>

<div id="outline-container-orgf0228cb" class="outline-3">
<h3 id="orgf0228cb"><a id="org2ee69c1"></a>crypto:Bad Primes<sup><a id="fnr.8" class="footref" href="#fn.8">8</a></sup></h3>
<div class="outline-text-3" id="text-orgf0228cb">
<p>
You're given \(c = flag^e \pmod{p\cdot q}\) with all numbers known except \(flag\).
The caveat is that \(e | p-1\) so there's no \(d = e^{-1} \pmod{p-1}\) for
recovering the flag directly. (Finding the flag \(\pmod q\) works trivially, so we
ignore that part.)
</p>

<p>
So finding the <i>e</i>-th root of \(c \pmod p\) is the interesting part. You can do it
in two different ways:
</p>

<p>
The I-don't-want-to-learn-anything Way (also known as
I'm-a-professional-I-don't-have-time-for-this): press the <code>[Skip This Step]</code>
button and do <code>GF(p)(c).nth_root(e)</code> in Sage.
</p>

<p>
The Problem Child Way:
</p>

<p>
So we want a number \(x\) such that \(x^e = c \pmod p\) with \(p-1 = e\cdot s\) and
\(gcd(s,e) = 1\).
</p>

<p>
The a-ha comes after exploring the hunch that \(s\) is important here. Look at \(j
 = e^{-1} \pmod s\). This means means \(j\cdot e = 1 + k\cdot s\) for some \(k\). In
fact, it means that \(j\cdot e\cdot e = e + k\cdot (p-1)\). A-ha! So now \((c^j)^e
 = c^{e \cdot j} = c^{k\cdot s + 1} = x^{e\cdot (k\cdot s + 1)} = x^{k\cdot
 (p-1) + e} = x^e \pmod p\). Voila! \(c^j\) is a root.
</p>

<p>
Other reasoning lines probably exist too, but this was the one I took.
</p>

<p>
Next step we iteratively multiply with any <i>e</i>-th root of unity (= \(r^{(p-1)/e}\)
for any primitive element \(r\)) to cycle through the rest of the roots,
reconstructing the number in under mod \(p\cdot q\) with CRT to check if it is the
flag.
</p>
</div>
</div>

<div id="outline-container-org6de9b29" class="outline-3">
<h3 id="org6de9b29">misc:BabyJS</h3>
<div class="outline-text-3" id="text-org6de9b29">
<p>
A misc task that was misclassified as web(?). It's an exposition on the various ways
JavaScript tries very hard to be an awful programming language<sup><a id="fnr.9" class="footref" href="#fn.9">9</a></sup>. It's
still not as awful as PHP, but we can't all be the champ.
</p>

<div class="org-src-container">
<pre class="src src-javascript">is<span style="color: #bdbdb3;">(</span>a, <span style="color: #CC5542;">'number'</span><span style="color: #bdbdb3;">)</span>;
is<span style="color: #bdbdb3;">(</span>b, <span style="color: #CC5542;">'number'</span><span style="color: #bdbdb3;">)</span>;
assert<span style="color: #bdbdb3;">(</span><span style="color: #CC5542;">'1.1'</span>, a === b<span style="color: #bdbdb3;">)</span>;
assert<span style="color: #bdbdb3;">(</span><span style="color: #CC5542;">'1.2'</span>, <span style="color: #6a7550;">1337</span> / a !== <span style="color: #6a7550;">1337</span> / b<span style="color: #bdbdb3;">)</span>;
</pre>
</div>

<p>
<code>[0.0, -0.0]</code> works because the division gives <code>[+Infinity, -Infinity]</code>. A
pimple, no big deal. Floats are tricky anyway.
</p>

<div class="org-src-container">
<pre class="src src-javascript">isnt<span style="color: #bdbdb3;">(</span>c, <span style="color: #CC5542;">'undefined'</span><span style="color: #bdbdb3;">)</span>;
isnt<span style="color: #bdbdb3;">(</span>d, <span style="color: #CC5542;">'undefined'</span><span style="color: #bdbdb3;">)</span>;
<span style="color: #7d7c61; font-weight: bold;">const</span> <span style="color: #fb8512;">cast</span> = <span style="color: #bdbdb3;">(</span>f, ...a<span style="color: #bdbdb3;">)</span> =&gt; a.map<span style="color: #bdbdb3;">(</span>f<span style="color: #bdbdb3;">)</span>;
<span style="color: #bdbdb3;">[</span>c, d<span style="color: #bdbdb3;">]</span> = cast<span style="color: #bdbdb3;">(</span>Number, c, d<span style="color: #bdbdb3;">)</span>;
assert<span style="color: #bdbdb3;">(</span><span style="color: #CC5542;">'2.1'</span>, c !== d<span style="color: #bdbdb3;">)</span>;
<span style="color: #bdbdb3;">[</span>c, d<span style="color: #bdbdb3;">]</span> = cast<span style="color: #bdbdb3;">(</span>String, c, d<span style="color: #bdbdb3;">)</span>;
assert<span style="color: #bdbdb3;">(</span><span style="color: #CC5542;">'2.2'</span>, c === d<span style="color: #bdbdb3;">)</span>;
</pre>
</div>

<p>
Probably a billion solutions here. I did <code>[{}, "[Object object]"]</code>. What's that
weird rash&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #7d7c61; font-weight: bold;">let</span> <span style="color: #bdbdb3;">{</span> e <span style="color: #bdbdb3;">}</span> = json;
is<span style="color: #bdbdb3;">(</span>e, <span style="color: #CC5542;">'number'</span><span style="color: #bdbdb3;">)</span>;
<span style="color: #7d7c61; font-weight: bold;">const</span> <span style="color: #fb8512;">isCorrect</span> = e++&lt;e--&amp;&amp;!++e&lt;!--e&amp;&amp;--e&gt;e++;
assert<span style="color: #bdbdb3;">(</span><span style="color: #CC5542;">'3'</span>, isCorrect<span style="color: #bdbdb3;">)</span>;
</pre>
</div>

<p>
Up to boils now. Actual boils. <code>&lt;!--</code> is a comment. \(e=-1\) works.
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #7d7c61; font-weight: bold;">const</span> <span style="color: #bdbdb3;">{</span> f <span style="color: #bdbdb3;">}</span> = json;
isnt<span style="color: #bdbdb3;">(</span>f, <span style="color: #CC5542;">'undefined'</span><span style="color: #bdbdb3;">)</span>;
assert<span style="color: #bdbdb3;">(</span><span style="color: #CC5542;">'4'</span>, f == !f<span style="color: #bdbdb3;">)</span>;
</pre>
</div>

<p>
<code>f=[]</code> works, I don't know why and I don't want to know. I fear that knowing
certain things actually make you less knowledgeable.
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #7d7c61; font-weight: bold;">const</span> <span style="color: #bdbdb3;">{</span> g <span style="color: #bdbdb3;">}</span> = json;
isnt<span style="color: #bdbdb3;">(</span>g, <span style="color: #CC5542;">'undefined'</span><span style="color: #bdbdb3;">)</span>;
<span style="color: #6abd50;">// </span><span style="color: #6aaf50;">what you see:</span>
<span style="color: #7d7c61; font-weight: bold;">function</span> <span style="color: #9b55c3;">check</span><span style="color: #bdbdb3;">(</span><span style="color: #fb8512;">x</span><span style="color: #bdbdb3;">)</span> <span style="color: #bdbdb3;">{</span>
    <span style="color: #7d7c61; font-weight: bold;">return</span> <span style="color: #6a9550;">{</span>
        value: x * x
    <span style="color: #6a9550;">}</span>;
<span style="color: #bdbdb3;">}</span>
<span style="color: #6abd50;">// </span><span style="color: #6aaf50;">what the tokenizer sees:</span>
<span style="color: #7d7c61; font-weight: bold;">function</span>
        check
             <span style="color: #bdbdb3;">(</span>
              x
               <span style="color: #bdbdb3;">)</span>
                <span style="color: #bdbdb3;">{</span>
                 <span style="color: #7d7c61; font-weight: bold;">return</span>
                       <span style="color: #6a9550;">{</span>
                        value
                             :
                              x
                               *
                                x
                                 <span style="color: #6a9550;">}</span>
                                  ;
                                   <span style="color: #bdbdb3;">}</span>
assert<span style="color: #bdbdb3;">(</span><span style="color: #CC5542;">'5'</span>, g == check<span style="color: #6a9550;">(</span>g<span style="color: #6a9550;">)</span><span style="color: #bdbdb3;">)</span>;
</pre>
</div>

<p>
This one was a little cute, like a magician's clever misdirection. The original
<code>check()</code> is replaced by this <code>check(x) { return; ... }</code> function. So <code>null</code>
works. Why does it return undefined? Haha!
<a href="https://news.ycombinator.com/item?id=3842713">https://news.ycombinator.com/item?id=3842713</a>
</p>

<p>
Blood-shot eyes, trichotillomania, psychosis.
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #7d7c61; font-weight: bold;">const</span> <span style="color: #bdbdb3;">{</span> h <span style="color: #bdbdb3;">}</span> = json;
is<span style="color: #bdbdb3;">(</span>h, <span style="color: #CC5542;">'number'</span><span style="color: #bdbdb3;">)</span>;
<span style="color: #7d7c61; font-weight: bold;">try</span> <span style="color: #bdbdb3;">{</span>
    JSON.parse<span style="color: #6a9550;">(</span>String<span style="color: #baba36;">(</span>h<span style="color: #baba36;">)</span><span style="color: #6a9550;">)</span>;
    no<span style="color: #6a9550;">(</span><span style="color: #CC5542;">'6'</span><span style="color: #6a9550;">)</span>;
<span style="color: #bdbdb3;">}</span> <span style="color: #7d7c61; font-weight: bold;">catch</span><span style="color: #bdbdb3;">(</span>e<span style="color: #bdbdb3;">){}</span>
passed<span style="color: #bdbdb3;">(</span><span style="color: #CC5542;">'6'</span><span style="color: #bdbdb3;">)</span>;
</pre>
</div>

<p>
Something like <code>1e1000</code> is converted to the string <code>"Infinity"</code>. Makes sense,
n'est-ce pas?
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #7d7c61; font-weight: bold;">const</span> <span style="color: #bdbdb3;">{</span> i <span style="color: #bdbdb3;">}</span> = json;
isnt<span style="color: #bdbdb3;">(</span>i, <span style="color: #CC5542;">'undefined'</span><span style="color: #bdbdb3;">)</span>;
assert<span style="color: #bdbdb3;">(</span><span style="color: #CC5542;">'7'</span>, i <span style="color: #7d7c61; font-weight: bold;">in</span> <span style="color: #6a9550;">[</span>,,,...<span style="color: #CC5542;">'"'</span>,,,Symbol.<span style="color: #7d7c61; font-weight: bold;">for</span><span style="color: #baba36;">(</span><span style="color: #CC5542;">"'"</span><span style="color: #baba36;">)</span>,,,<span style="color: #6a9550;">]</span><span style="color: #bdbdb3;">)</span>;
</pre>
</div>

<p>
This unending dream. <code>3</code> is in the array because array index 3 is defined? I
don't know the logic. Any language which tries to pretend lists and maps are
somehow isomorphic data structures or algebras is insane. These languages were
invented by insane people.
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #7d7c61; font-weight: bold;">const</span> <span style="color: #fb8512;">js</span> = eval<span style="color: #bdbdb3;">(</span><span style="color: #CC5542;">`(${clean})`</span><span style="color: #bdbdb3;">)</span>;
assert<span style="color: #bdbdb3;">(</span><span style="color: #CC5542;">'8'</span>, Object.keys<span style="color: #6a9550;">(</span>json<span style="color: #6a9550;">)</span>.length !== Object.keys<span style="color: #6a9550;">(</span>js<span style="color: #6a9550;">)</span>.length<span style="color: #bdbdb3;">)</span>;
</pre>
</div>

<p>
Put <code>__proto__</code> in the object and it will get hidden by the eval, because <code>:jazzhands-OO:</code>.
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #7d7c61; font-weight: bold;">const</span> <span style="color: #bdbdb3;">{</span> y, z <span style="color: #bdbdb3;">}</span> = json;
isnt<span style="color: #bdbdb3;">(</span>y, <span style="color: #CC5542;">'undefined'</span><span style="color: #bdbdb3;">)</span>;
isnt<span style="color: #bdbdb3;">(</span>z, <span style="color: #CC5542;">'undefined'</span><span style="color: #bdbdb3;">)</span>;
y<span style="color: #bdbdb3;">[</span>y<span style="color: #bdbdb3;">][</span>y<span style="color: #bdbdb3;">](</span>z<span style="color: #bdbdb3;">)()(</span>FLAG<span style="color: #bdbdb3;">)</span>;
</pre>
</div>

<p>
When I looked over the task I figured I could pass all the other checks, but
this one seemed a bit need-to-actually-stop-and-think, "huh?" It had me puzzled
for a while, I don't really know JavaScript all that well. (I had to ask Google
if JavaScript has apply-overriding and stuff like that.) I also didn't realize
that <i>everything</i> has a <code>.constructor</code>. But eventually I discovered it just by
playing around in <code>nodejs</code> and from that a-ha the pieces fell into place.
</p>

<p>
<code>y = "constructor"</code> so <code>y[y]</code> becomes a function, i.e. <code>y.constructor</code>, and <code>y[y][y]</code> becomes the
function constructor, which takes its body as a string argument (?!) to be
eval'd. So <code>z = "return console.log;"</code> for example.
</p>
</div>
</div>

<div id="outline-container-org04ab205" class="outline-3">
<h3 id="org04ab205">crypto:Conquering Premium Access</h3>
<div class="outline-text-3" id="text-org04ab205">
<p>
AES is used to encrypt the flag. You're handed the ciphertext and "power traces"
(voltage measurement?) of some hardware using AES to encrypt 10,000 known
16-byte plaintexts with the same key/IV as it did the flag.
</p>

<p>
The task hints about "T-tables", "aligned" and that masking isn't employed. But
the task also said "thank you to professor so-and-so for the data" and links to
a university course, which is the biggest clue in my eyes. From that I figured
it's probably very "textbook" and intended to be solved with least effort.
</p>

<p>
So, textbook reading material:
<a href="https://www.tandfonline.com/doi/full/10.1080/23742917.2016.1231523">https://www.tandfonline.com/doi/full/10.1080/23742917.2016.1231523</a>
</p>

<p>
Indeed: almost disappointingly so. Finding a correlation based on the
1-bits-equals-more-power assumption turned out to work directly. You can ignore
the rounds, ignore the hints<sup><a id="fnr.10" class="footref" href="#fn.10">10</a></sup>, ignore everything, because there's so much
data and it's so artificially clean. Find the <code>key</code> (and <code>iv</code>) such that the
weight of <code>sbox[key^iv^plaintext]</code> has the highest correlation with (overall)
power consumption. <code>sbox[key^iv^plaintext]</code> is what the state gets set to in the
first round (in CBC mode), before <code>ShiftRows</code> etc. (Note that <code>ShiftRows</code>
doesn't change the weight.) Technically I ignored IV too because I simply forgot
about it, but that was fine too. You can simply use the full traces, and don't
have to target any point in time at all.
</p>

<p>
See also:
<a href="https://teamrocketist.github.io/2018/11/14/Crypto-SquareCtf-2018-C4-leaky-power/">https://teamrocketist.github.io/2018/11/14/Crypto-SquareCtf-2018-C4-leaky-power/</a>
which I also came across and seems to copy a lot of text/material from the above
link, but is a much more thorough write-up than anything I can produce.
</p>

<p>
Notice how it's also a verrrry similar problem? Yep: copy-pasting that code
should just work out of the box here too, though it is awful and slow so I ended
up rewriting it and doing most of my playing in REPL to pretend I wasn't a
fraud, trying to learn something in spite of everything.
</p>

<p>
And yeah, AES ECB to decrypt, so no IV was used, which I as stated implicitly
assumed. Can't recall if the task hinted to that or not, maybe it did?
</p>
</div>
</div>

<div id="outline-container-org89eaf2b" class="outline-3">
<h3 id="org89eaf2b">misc:P*rn Protocol</h3>
<div class="outline-text-3" id="text-org89eaf2b">
<p>
A PDF described a very simple data protocol. Implement the protocol, request
login, log in with the given username and password, and get the flag.
</p>

<p>
Uhh?
</p>

<p>
This felt more like a "socket programming for beginners" tutorial than anything
else. Why was this even part of the task set?
</p>
</div>
</div>

<div id="outline-container-org01f41cd" class="outline-3">
<h3 id="org01f41cd">crypto:Pwnhub Collection</h3>
<div class="outline-text-3" id="text-org01f41cd">
<p>
Labelled as hard crypto but really just easy-ish crypto gated behind ASAN rev.
<code>poiko</code> reversed it for me because I'm a newbie, so can't really say much about
the rev part.
</p>

<p>
So from what <code>poiko</code> told me, the server does something roughly equivalent of
the following pseudocode:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #6abd50;"># </span><span style="color: #6aaf50;">coll = list of pairs (category, link)</span>
<span style="color: #fb8512;">coll</span> = <span style="color: #bdbdb3;">[</span>t.strip<span style="color: #6a9550;">()</span>.split<span style="color: #6a9550;">(</span><span style="color: #CC5542;">' '</span><span style="color: #6a9550;">)</span> <span style="color: #7d7c61; font-weight: bold;">for</span> t <span style="color: #7d7c61; font-weight: bold;">in</span> <span style="color: #bdbdb3; font-weight: bold;">open</span><span style="color: #6a9550;">(</span><span style="color: #CC5542;">'collection'</span><span style="color: #6a9550;">)</span><span style="color: #bdbdb3;">]</span>
coll.append<span style="color: #bdbdb3;">(</span> <span style="color: #6a9550;">(</span><span style="color: #bdbdb3; font-weight: bold;">input</span><span style="color: #baba36;">()</span>, <span style="color: #bdbdb3; font-weight: bold;">input</span><span style="color: #baba36;">()</span><span style="color: #6a9550;">)</span> <span style="color: #bdbdb3;">)</span>

<span style="color: #fb8512;">txt</span> = <span style="color: #CC5542;">' '</span>.join<span style="color: #bdbdb3;">(</span>x + <span style="color: #CC5542;">'{'</span> + y + <span style="color: #CC5542;">'}'</span> <span style="color: #7d7c61; font-weight: bold;">for</span> x,y <span style="color: #7d7c61; font-weight: bold;">in</span> <span style="color: #bdbdb3; font-weight: bold;">sorted</span><span style="color: #6a9550;">(</span>coll, key=<span style="color: #7d7c61; font-weight: bold;">lambda</span> x:x<span style="color: #baba36;">[</span><span style="color: #6a7550;">0</span><span style="color: #baba36;">]</span><span style="color: #6a9550;">)</span><span style="color: #bdbdb3;">)</span>
<span style="color: #6abd50;"># </span><span style="color: #6aaf50;">NB: sorted only on category element</span>

<span style="color: #7d7c61; font-weight: bold;">print</span><span style="color: #bdbdb3;">(</span>aes_cbc<span style="color: #6a9550;">(</span>fixed_key, fixed_iv, txt<span style="color: #6a9550;">)</span>.hexdigest<span style="color: #6a9550;">()</span><span style="color: #bdbdb3;">)</span>
</pre>
</div>

<p>
So there's a string like <code>"blah{bleh} foo{bar} qux{crux}"</code> where we can add an
element that gets sorted in.
</p>

<p>
Finding the "categories" (the strings outside the curly braces) can be done very
efficiently with a binary search. Start with a string like <code>byte(127)*n</code> that
gets sorted last, observe the ciphertext output. Then for each byte keep a
<code>high,low</code> that you bisect and observe if we were flipped to another position in
the string (an earlier ciphertext block will change). This finds all the
categories very quickly.
</p>

<p>
They turned out to be <code>crypto flag misc</code> etc. (Which was something <code>poiko</code>
already guessed from doing the rev part, but I just double-checked.) Next step
is discovering the stuff inside the curly braces. Because I was being dumb, it
took me longer than it should have to realize it's the even-more-textbook method
of byte-by-byte brute forcing.
</p>

<p>
Input a category that gets sorted before <code>flag</code> with a long arbitrary link that
aligns things like so:
</p>

<pre class="example">
# |---aes block---||---aes block---||---aes block---|
# xxxx f{aaaaaaaaaaaaaaaaaaaa} flag{xxxxxxxxxxxxxxxxx
</pre>

<p>
Now pop off one <code>a</code> so the first <code>x</code> gets shifted in and note what that block
becomes in the output. Then discover the byte by cycling through and check the
output of encrypting with <code>link = "aaaa...aaaa} flag{" + b</code> for unknown byte
<code>b</code>. I.e. the string that's encrypted becomes:
</p>

<pre class="example">
# |---aes block---||---aes block---||---aes block---|
# xxxx f{aaaaaaaaaaaaaaaaaaa} flag{*} flag{xxxxxxxxxx
# with '*' being the variable byte.
</pre>

<p>
Once there's a match you add the byte to what you know is there already (<code>"}
 flag{"</code>) and repeat for the next byte, until the entire link has been
discovered. Print it, ship it, done.
</p>
</div>
</div>
</div>



<div id="outline-container-orgcd851c6" class="outline-2">
<h2 id="orgcd851c6">CyberSecurityRumble 2020</h2>
<div class="outline-text-2" id="text-orgcd851c6">
</div>
<div id="outline-container-orgc866158" class="outline-3">
<h3 id="orgc866158">General Comments</h3>
<div class="outline-text-3" id="text-orgc866158">
<p>
Overall a pretty good CTF. Decent number of tasks, variety, difficulty level and
so forth. The stuff I looked at seemed alright, though I got entangled in some
web business toward the end that soured things but that was my own fault.
</p>

<p>
We placed a cool 10th tho (much thanks to <code>poiko</code> spamming flags left and right
the last day).
</p>

<p>
There wasn't an <i>abundance</i> of crypto or mathematical misc tasks, but then I
don't really come to expect that much, it felt like there was <i>enough</i>. I kinda
think of crypto/math as the awkward little sister that's there only because the
organizers' mother forced them to bring her along. The cool kids are talking
about real world stuff, hacking the Gibson, phreaking the phone lines, doing bug
bounties, whatever it is that real hackermen do, while she's just sitting there
arranging her fries to count out the Stirling numbers. Most of the time I'm just
glad she's invited at all; if CTFs were to reflect real world industry, I
suspect it'd be like 30 web-tasks and 2 revs.
</p>

<p>
I solved most of the easy crypto on the first evening, then did <a href="#orgb023fb6">crypto:dtls</a> the
following morning, but the two remaining tasks were labelled web. Ugh. I looked
at the task named <code>blow</code> and just thought "fuck no." Some kind of hellish
JWS/JWT JavaScript task they kept adding hints to because it got no
solves. From the hints alone I surmised that it has some trivial solution in
crypto terms, but it was probably a pain in the ass (aka the "web" part) to even
get started or progress to where it's relevant? So I worked on <a href="#org32f0d87">web:Yanote</a>
instead, but failed that task miserably and eventually went off to nurse my
imposter syndrome in the corner.
</p>
</div>
</div>

<div id="outline-container-org2023a3d" class="outline-3">
<h3 id="org2023a3d">crypto:Pady McPadface</h3>
<div class="outline-text-3" id="text-org2023a3d">
<p>
A live server that knows the flag traverses it bit by bit and gives \((r^2 +
bit)^e \pmod n\) for a fixed RSA modulus \(n\) using the standard \(e = 65537\). \(r\)
is an ephemeral random number a few bits than \(log_2 \sqrt{n}\) so \(r^2 < n\).
</p>

<p>
So basically I wanted to discover if the ciphertexts were quadratic residues or
not under the given (composite) modulus. I knew what to look up, and it turned
out to be pretty easy, but I was actually surprised to learn the Jacobi symbol
is easily calculable without knowing the factorization of \(n\). Huh! (It's also
surprising that this has never come up before.) I'm glad to have learnt it, it
does seem like a neat trick.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #7d7c61; font-weight: bold;">def</span> <span style="color: #9b55c3;">trailing_zeros</span><span style="color: #bdbdb3;">(</span>a<span style="color: #bdbdb3;">)</span>:
  <span style="color: #7d7c61; font-weight: bold;">return</span> <span style="color: #bdbdb3;">(</span>a ^ a - <span style="color: #6a7550;">1</span><span style="color: #bdbdb3;">)</span>.bit_length<span style="color: #bdbdb3;">()</span> - <span style="color: #6a7550;">1</span>

<span style="color: #7d7c61; font-weight: bold;">def</span> <span style="color: #9b55c3;">jacobi</span><span style="color: #bdbdb3;">(</span>a,n<span style="color: #bdbdb3;">)</span>:
  <span style="color: #7d7c61; font-weight: bold;">assert</span> n &amp; <span style="color: #6a7550;">1</span> <span style="color: #6abd50;"># </span><span style="color: #6aaf50;">n must be odd</span>
  <span style="color: #fb8512;">sign</span> = <span style="color: #6a7550;">1</span>

  <span style="color: #fb8512;">a</span> = a % n
  <span style="color: #7d7c61; font-weight: bold;">while</span> a &gt; <span style="color: #6a7550;">0</span>:
    <span style="color: #fb8512;">r</span> = trailing_zeros<span style="color: #bdbdb3;">(</span>a<span style="color: #bdbdb3;">)</span>

    <span style="color: #6abd50;"># </span><span style="color: #6aaf50;">2 divides an odd number of times into a, then flip the sign if n is not</span>
    <span style="color: #6abd50;"># </span><span style="color: #6aaf50;">on the form 8k&#177;1</span>
    <span style="color: #7d7c61; font-weight: bold;">if</span> n % <span style="color: #6a7550;">8</span> <span style="color: #7d7c61; font-weight: bold;">in</span> <span style="color: #bdbdb3;">(</span><span style="color: #6a7550;">3</span>,<span style="color: #6a7550;">5</span><span style="color: #bdbdb3;">)</span> <span style="color: #7d7c61; font-weight: bold;">and</span> r &amp; <span style="color: #6a7550;">1</span>:
      <span style="color: #fb8512;">sign</span> = -sign

    <span style="color: #fb8512;">a</span>,<span style="color: #fb8512;">n</span> = n, a &gt;&gt; r
    <span style="color: #7d7c61; font-weight: bold;">if</span> a % <span style="color: #6a7550;">4</span> == <span style="color: #6a7550;">3</span> <span style="color: #7d7c61; font-weight: bold;">and</span> n % <span style="color: #6a7550;">4</span> == <span style="color: #6a7550;">3</span>:
      <span style="color: #fb8512;">sign</span> = -sign
    <span style="color: #fb8512;">a</span> = a % n

  <span style="color: #7d7c61; font-weight: bold;">if</span> n != <span style="color: #6a7550;">1</span>:
    <span style="color: #6abd50;"># </span><span style="color: #6aaf50;">a divides into n</span>
    <span style="color: #7d7c61; font-weight: bold;">return</span> <span style="color: #6a7550;">0</span>

  <span style="color: #7d7c61; font-weight: bold;">return</span> sign
</pre>
</div>

<p>
So then it was a matter of connecting to the server and getting several
ciphertext instances and calculating their Jacobi symbols
\(\left(\frac{c}{n}\right)\). If you find an instance where it is -1 then you know
the number is not a quadratic residue, so \(bit\) must be 1 in that position.
After some collected data you set the others to 0 and get the flag.
</p>
</div>
</div>

<div id="outline-container-org921c43e" class="outline-3">
<h3 id="org921c43e">crypto:dlog</h3>
<div class="outline-text-3" id="text-org921c43e">
<p>
The task implements some basic code for working with the secp256k1 elliptic
curve (\(y^2 = x^3 + 7\)). The ECC implementation is "home-made" with code mostly
taken from Wikipedia. It asks for a point, multiplies it with a random secret
number and asks you to recover this secret. No check is done on whether or not
the point you give is actually on the secp256k1 curve though, so it's a classic
invalid curve attack.
</p>

<p>
Basically you can set the \(b\) parameter in \(y^2 = x^3 + b\) to whatever you want.
(If you give the point \((s,t)\) it will use the curve \(y^2 = x^3 + (t^2-s^3)\).)
I've solved some task before using a singular curve but couldn't remember how
the mapping worked off the top of my head and didn't find my old code for it, so
instead I idly looked for other \(b\) parameters where I could solve the discrete
log with Pohlig-Hellman as I had the tools for that more readily available. I
think there's 7 (?) different Frobenius traces among these curves, corresponding
to different orders of the resulting elliptic curve, but each had a very large
factor (133-135 bits) so this turned out to be a dead end.
</p>

<p>
I went back to pen and paper to see if I could manually work out the singular
mapping, partly as self-punishment for forgetting. Given one of the simplest
non-trivial points, \((1,1)\), the server will use the singular non-elliptic curve
\(y^2 = x^3\). The point-doubling formula then does the following: \(x \mapsto
\left(\frac{3x^2}{2y}\right)^2 - 2x = \frac{1}{4}x\) and similarly \(y \mapsto \frac{1}{8}y\).
Hm! That gave me the needed deja vu: indeed it seems that \(\frac{(n *
(1,1))_x}{(n * (1,1))_y} = n\), so it worked out nicely, and I didn't have to
wade through the full algebra. So yeah, just feed it <code>(1,1)</code> and then do \(\frac{x}{y}
\pmod p\) to get the secret.
</p>

<p>
It's probably supposed to be a pretty trivial task, but I made it overly
complicated by investigating all the curve-stuff.
</p>
</div>
</div>

<div id="outline-container-org6341570" class="outline-3">
<h3 id="org6341570">crypto:ezdsa</h3>
<div class="outline-text-3" id="text-org6341570">
<p>
A server is signing messages using the Python <code>ecdsa</code> library. I don't remember
the exact details but I think you were supposed to forge a signature.
Immediately there's was a glaring red flag with a <code>entropy=sony_rand</code> parameter
where <code>sony_rand</code> was a function that returned random bytes using Python's
<code>random</code> module. <code>ecdsa</code> uses this for generating the ephemeral \(k\) in its DSA
signature generation.
</p>

<p>
At first I thought this was going to be a very challenging task, because even
though the randomness of <code>getrandbits</code> isn't of cryptographic quality, it's very
hard to actually mirror it unless given at least some white (fully revealed)
output. I know it's seeded in Python from PID and two different clock functions,
so it might be bruteable, but it's hard to predict how far into the stream the
server is and so on and so forth; it seemed very daunting to brute all that. I
wondered if you could get startup time or restart the server, or maybe the
Mersenne Twister output had some cool linear relationship I wasn't aware of&#x2026;
</p>

<p>
I was just being dumb. I didn't notice it was a forking TCP server&#x2026; It will
clone the state and basically just re-use the same ephemeral \(k\) every single
time. This becomes immediately obvious when you set to actually collect some
signatures and see the \(r\) being repeated. I got pretty lucky that it was so
obvious once you start collecting data, if not it'd be screwed.
</p>

<p>
So from two signatures \((r, \frac{H_1 + r x}{k})\) and \((r, \frac{H_2 + r x}{k})\)
where you can calculate the hashes \(H_1, H_2\), recovering the private multiplier
\(x\) is trivial and you can sign anything. I think I just set
<code>sk.privkey.secret_multiplier = x</code> and used <code>ecdsa</code> to do it in REPL.
</p>
</div>
</div>

<div id="outline-container-orga4e13c9" class="outline-3">
<h3 id="orga4e13c9">misc:Pylindrome</h3>
<div class="outline-text-3" id="text-orga4e13c9">
<p>
A server will run any Python code that's a valid palindrome (<code>x == x[::-1]</code>) in
a Python subprocess (of a user that can't read the flag file), but then <code>exec</code>
the <code>stdout</code> from that process (in the process that can read the flag file).
There's a limited attempt at preventing the task from becoming trivial: it will
remove any of the substrings <code>"#", '"""', "'''"</code> from the input. The removal
happens only once, <i>in order</i>. So, the a-ha: you can actually use <code>"""</code> by
giving something like <code>"'''""</code>. The server will remove the single quotes and
keep the double ones.
</p>

<p>
Unfortunately I don't have the actual solution at hand since I can't find it in
my REPL history, but the basic idea was to just use a simple payload like
<code>print("__import__('os').system('sh')")</code> and then figure out how to make that
into a palindrome. I think I settled on something like
<code>""";";""";&lt;code&gt;;""";&lt;reverse of code&gt;;""";";"""</code>. Notice how <code>""";";"""</code> is
interpreted to be the string <code>';";'</code> when evaluated normally, but also provides
an end for the triple-quote: <code>..."""; ";" ""</code>.
</p>

<p>
(Another idea would be to use some trickery involving the escape character
<code>r"\"</code> which could potentially escape/unescape strings depending on order, but I
didn't think of that at the time.)
</p>
</div>
</div>

<div id="outline-container-org2614d67" class="outline-3">
<h3 id="org2614d67">baby:Hashfun</h3>
<div class="outline-text-3" id="text-org2614d67">
<p>
Trivial welcome-task I had missed until <code>poiko</code> reminded me. It basically does
<code>print(flag ^ flag[4:])</code> (if one were able to do that in Python). You know
<code>flag</code> starts with <code>CSR{</code> which gives you the next four bytes, and those gives
the next four, and so on.
</p>
</div>
</div>

<div id="outline-container-orgb023fb6" class="outline-3">
<h3 id="orgb023fb6">crypto:dtls</h3>
<div class="outline-text-3" id="text-orgb023fb6">
<p>
The task gives you a pcap file and this shell script:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #6abd50;"># </span><span style="color: #6aaf50;">/usr/lib/libc.so.6|head -n 1</span>
<span style="color: #6abd50;"># </span><span style="color: #6aaf50;">GNU C Library (GNU libc) stable release version 2.31.</span>

<span style="color: #6abd50;"># </span><span style="color: #6aaf50;">clone</span>
git clone https://github.com/eclipse/tinydtls.git dtls

<span style="color: #6abd50;"># </span><span style="color: #6aaf50;">build</span>
<span style="color: #bdbdb3; font-weight: bold;">cd</span> dtls &amp;&amp; autoconf &amp;&amp; autoheader &amp;&amp; ./configure &amp;&amp; make &amp;&amp; <span style="color: #bdbdb3; font-weight: bold;">cd</span> ..

<span style="color: #6abd50;"># </span><span style="color: #6aaf50;">listen</span>
tcpdump -i lo  port <span style="color: #6a7550;">31337</span> -w dump.pcap &amp;

<span style="color: #6abd50;"># </span><span style="color: #6aaf50;">Wait for tcpdump...</span>
sleep <span style="color: #6a7550;">2</span>

<span style="color: #6abd50;"># </span><span style="color: #6aaf50;">serve</span>
dtls/tests/dtls-server -p <span style="color: #6a7550;">31337</span> &amp;

<span style="color: #6abd50;"># </span><span style="color: #6aaf50;">send flag</span>
cat flag.txt|dtls/tests/dtls-client <span style="color: #6a7550;">127.0.0.1</span> -p <span style="color: #6a7550;">31337</span>
</pre>
</div>

<p>
I got the repo and looked around. I know it implements basic TLS over UDP, but
ignored all that. The first thing I searched for was RNG. It doesn't use
cryptographic source of random numbers but instead will just use <code>srand()</code> and
<code>rand()</code> from <code>libc</code> (as hinted to in the script above). That's a problem in
and by itself.
</p>

<p>
But it also turns out that the code is buggy, for example it initializes the RNG
with <code>dtls_prng_init((unsigned long)*buf)</code>, where <code>buf</code> was read to from
<code>/dev/urandom</code>. It's probably <i>intending</i> to use a <code>long</code> for the seed, but guess
what? <code>buf</code> is a <code>char</code> array, so it's actually just using a single byte for the
seed to generate all those important crypto bytes.
</p>

<p>
Now, how to actually attack it. I knew I didn't want to actually interact
with TLS, because TLS is web and web is a hell run by committees, so
instead I did the following:
</p>

<ul class="org-ul">
<li>Make it print out the random bytes it generates. Run the script and compare
it with the given pcap to figure out where those numbers go and what they
should actually be.</li>
<li>Trivially brute the seed.</li>
<li>Modify the library to load its seed from an environment variable so I could
run the client and server with fixed seeds.</li>
<li>Force its internal time function to return 0, as I can see from the pcap
that's what it used there. (It actually tries to use integer seconds since the
start of the program, thus 0 since the transfer happens immediately.)</li>
</ul>

<p>
I ran the script again and compared my pcap with the one given. It's generating
and using the same numbers, uses the same cookie, etc. So then I simply copied
the final encrypted packet from the pcap file and put it into the source code
with an ugly hack like this:
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #7d7c61; font-weight: bold;">static</span> <span style="color: #528fd1;">char</span> <span style="color: #fb8512;">bufzzz</span><span style="color: #bdbdb3;">[]</span> = <span style="color: #CC5542;">"...stuff..."</span>;

<span style="color: #7d7c61; font-weight: bold;">static</span> <span style="color: #528fd1;">int</span>
<span style="color: #9b55c3;">decrypt_verify</span><span style="color: #bdbdb3;">(</span><span style="color: #528fd1;">dtls_peer_t</span> *<span style="color: #fb8512;">peer</span>, <span style="color: #528fd1;">uint8</span> *<span style="color: #fb8512;">packet</span>, <span style="color: #528fd1;">size_t</span> <span style="color: #fb8512;">length</span>,
         <span style="color: #528fd1;">uint8</span> **<span style="color: #fb8512;">cleartext</span><span style="color: #bdbdb3;">)</span>
<span style="color: #bdbdb3;">{</span>
  <span style="color: #7d7c61; font-weight: bold;">if</span> <span style="color: #6a9550;">(</span>packet<span style="color: #baba36;">[</span><span style="color: #6a7550;">0</span><span style="color: #baba36;">]</span> == <span style="color: #6a7550;">0x17</span><span style="color: #6a9550;">)</span> <span style="color: #6a9550;">{</span>
    printf<span style="color: #baba36;">(</span><span style="color: #CC5542;">"pulling the old switcharoo\n"</span><span style="color: #baba36;">)</span>;
    packet = bufzzz;
    length = <span style="color: #6a7550;">84</span>;
  <span style="color: #6a9550;">}</span>

  <span style="color: #6abd50;">// </span><span style="color: #6aaf50;">...</span>
</pre>
</div>

<p>
For some reason (that I don't care about) this causes TinyDTLS' own debug
printing of the message to get messed up, so I also had to print the cleartext
myself at the end of the function. Out comes the flag. No TLS needed (thank
God).
</p>

<p>
This was a pretty cool task. It was practical and "real-world" but without
feeling contrived and without there being JavaScript or any web frameworks
involved. It was possibly the "cleanest" real-world-y task I've seen. Well done
to the task author.
</p>
</div>
</div>

<div id="outline-container-org32f0d87" class="outline-3">
<h3 id="org32f0d87">web:Yanote</h3>
<div class="outline-text-3" id="text-org32f0d87">
<p>
I didn't solve this one. I failed it. Not only did I fail it technically, but I
failed it <i>mentally</i>, which is probably worse. But I worked on it for a while so
I'm still going to write about it. It triggered all sorts of feelings of
inadequacy and failure that you wouldn't believe.
</p>

<p>
All because of this "web" tag.
</p>

<p>
The "web" tag usually means "use educated guesses for any blackbox behavior" but
to me it usually reads as "realize that nobody agrees with what you think is
reasonable." It reads "smell that? Take a deep whiff, that's the smell of
learned helplessness, baby."
</p>

<p>
Clue: the server says "invalid CRC-HMAC" if you give it an invalid cookie.
</p>

<p>
Ignore the pedantic fact that it would normally be called <code>HMAC-&lt;name&gt;</code> and
"CRC" is very non-specific, kind of like just saying "HASH."
</p>

<p>
However CRCs are more fun than hashes in that they're easier to play around with
computationally. So for a second I dared to dream about some sort of semi-fun
task of trying to figure out the modulus and key and all the other constants of
some unknown <code>HMAC(key, ipad, opad, H=CRC(modulus, a, b))</code> given an <code>oracle(x) =
HMAC(key, A+x+B)</code>. That would have been pretty nice actually.
</p>

<p>
So my approach was all wrong. Because I started to hear this "looOOooOOoOool"
coming from a dark corner of my mind: the "web" tag coming back to haunt me. So
maybe none of that cool stuff. Maybe it's just&#x2026;straight up CRC-32&#x2026;? Well,
yes and no.
</p>

<p>
See, I hate this. Instead of "figuring something out" you have to guess what
<i>they</i> mean about what that something is. Since it's "web" and in web they tend
to not be too particular about things, HMAC might mean something else.
Potentially it could be a homegrown custom HMAC, potentially it could be
something else entirely. It's not even given that it does <code>HMAC(&lt;key&gt;,
&lt;pickle-data&gt;)</code>. For all you know it could do <code>F(&lt;key&gt;, &lt;username&gt; + ":" +
&lt;permission&gt;)</code> or whatever. Hell, maybe it's not even a CRC! Maybe it's just
<code>adler32(&lt;data&gt; + &lt;secret&gt;)</code>&#x2026;
</p>

<p>
Okay, relax. Start testing some basic stuff.
</p>

<p>
I figured out it had normal CRC behavior at least. It was, as they say,
affine-ish. Working with polynomials over \(\mathbb{Z}_2\), \(CRC(x + y) = CRC(x) +
CRC(y) + K_{b}\) where \(K_{b}\) is a constant that depends on the <i>byte-lengths</i> of
<code>x</code> and <code>y</code> (technically on their xor difference?). You'd expect this to work for
any HMAC based on a CRC too. This allows you to (easily) log in as admin (but on
the admin page I just found people doing "test post pls ignore" and being
generally "????????").
</p>

<p>
But when I actually tried to "solve" the blackbox function completely, I kept
getting wrong constants everywhere. And I didn't know what was wrong, didn't
know if it's because I had bugs in the old code I was using (some <code>GF2[X]</code>
implementation from way back), or had some wrong assumption.
</p>

<p>
After a while I suspected there was no HMAC and maybe just a straight up unknown
CRC, which frustrated me even more because if so, then this should be easy, no?
What if something else is different? I spammed random stuff trying to figure out
the modulus for the CRC from the constants I was getting out, double-checked my
math&#x2026; I even wondered if you were supposed to birthday-hammer user-create to
find a duplicate checksum, and maybe that would finally reveal what was going
on, got completely lost&#x2026;
</p>

<p>
Getting full control over the cookie <i>is</i> trickier, but in my more clear-headed
state I think it's possible without solving the black-box function as I was
trying to do. I believe all you need is in the relationship. You can get all the
constant <code>K</code> terms you need by making three users that xor to zero for any given
length. For an unknown CRC, for three constants \(K_i\), \(K_{i+1}\) and \(K_{i+2}\)
(that you'd get from <code>("0","q","A")</code> for example, since they xor to 0), then you
can find the modulus as a factor of \(x^8 K_{i+2} + (x^8+1) K_{i+1} + K_{i}\)
(does that work? Now I'm not sure, I'm copying a note&#x2026;), then the relationship
between the various \(K_i\) as \(K_n = K_0 \frac{x^n-1}{(x-1) x^{n-1}} \pmod M\)
(TODO: math might be wrong), and you should have everything you need.
</p>

<p>
Then you make usernames that xor together to be your pickle payload (the server
accepted non-printables in username) and change the byte for the username length
(this last part is a pen-and-paper mess, so it's not something I'd actually try
unless I was sure). The stuff after the byte <code>0x2e (".")</code> in the pickle data is
ignored, so it's fine if the cookie ends with garbage. This was probably the
intended solution, though it's a bug-prone approach, maybe a bit painful to
implement.
</p>

<p>
However I basically just got so frustrated with not getting the math to work out
(I mean, I couldn't even figure out the damn <i>modulus</i>!<sup><a id="fnr.11" class="footref" href="#fn.11">11</a></sup>) and debugging my
own code that I gave up. I have an issue with committing to guesses unless I
have a reasonable idea it will work. <i>Failure-sensitive</i>. Besides, engaging with
guessy stuff feels dirty unless you vibe some level of mental harmony with the
task author (which I didn't).
</p>

<p>
Dirty confession: I even debased myself and tried to brute force a 32-bit key
against HMAC-CRC32 using the usual constants, but it didn't work. That was the
last straw. After that I signed off and went for a long walk to hang out with
the ducks by the river (not a metaphor&#x2013;there are actual ducks).
</p>

<p>
<i>Addendum:</i> it was plain CRC-32, and the "HMAC" just a salt being added to the
data bytestring. Prefix or postfix salt? Length of salt? Well, it's web, so the
answer could be to just guess and try it, and if that doesn't work, guess
something else.
</p>
</div>
</div>
</div>


<div id="outline-container-org2466d88" class="outline-2">
<h2 id="org2466d88">BalsnCTF 2020</h2>
<div class="outline-text-2" id="text-org2466d88">
</div>
<div id="outline-container-org07e5e23" class="outline-3">
<h3 id="balsn2020"><a id="org07e5e23"></a>General Comments</h3>
<div class="outline-text-3" id="text-balsn2020">
<p>
Another great CTF!
</p>

<p>
But yet again I have some Debbie Downer comments.
</p>

<p>
Disclaimer: this is clearly a top-tier CTF, close to ~100 points, so my main
criticisms below are more subjective and personal than objective. I will be
playing the part of <a href="https://www.youtube.com/watch?v=48aUMXifAn8">Wolfgang</a>, so I might seem a lot more negative than what is
deserved.
</p>

<p>
The difficulty of <i>certain</i> tasks seemed to come from them simply being the
composition of several sub-tasks that <i>in some cases</i> weren't even related. I am
not a fan of that at all. It's exhausting and it feels like a really cheap way
to increase difficulty. <a href="#org5285b32">Happy Farm</a> is the obvious example<sup><a id="fnr.12" class="footref" href="#fn.12">12</a></sup>. Instead of
having tasks T1, T2, T3 that are all fairly independent problems, they're
composed or chained in some way to make a much more work-intensive task. This
joined task can even appear more difficult than the most difficult in the
set<sup><a id="fnr.13" class="footref" href="#fn.13">13</a></sup>, yet <i>it won't feel that rewarding</i>.
</p>

<p>
That's just a strong personal preference, perhaps other people think it's cool
and the bee's knees. I preferred <a href="#orga29648a">N1CTF2020</a> for example, which had a similar
difficulty level, but where none of the tasks seemed "artificially" difficult by
composition or layering.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #7d7c61; font-weight: bold;">import</span> random
random.seed<span style="color: #bdbdb3;">(</span><span style="color: #bdbdb3; font-weight: bold;">int</span><span style="color: #6a9550;">(</span><span style="color: #bdbdb3; font-weight: bold;">input</span><span style="color: #baba36;">()</span><span style="color: #6a9550;">)</span><span style="color: #bdbdb3;">)</span>

<span style="color: #7d7c61; font-weight: bold;">assert</span> \
b<span style="color: #CC5542;">"""As an extreme example, what if every category was just a single chained</span>
<span style="color: #CC5542;">monster-task? No flag until you do them all. I personally am /much/ more</span>
<span style="color: #CC5542;">comfortable on the other end of this spectrum, where it's a series of smaller</span>
<span style="color: #CC5542;">bite-sized puzzles. Composing small but hard-ish puzzles isn't /that/ difficult.</span>
<span style="color: #CC5542;">Here's one, for example."""</span> == random.getrandbits<span style="color: #bdbdb3;">(</span><span style="color: #6a7550;">8</span>*<span style="color: #6a7550;">328</span><span style="color: #bdbdb3;">)</span>.to_bytes<span style="color: #bdbdb3;">(</span><span style="color: #6a7550;">328</span>, <span style="color: #CC5542;">'big'</span><span style="color: #bdbdb3;">)</span>
</pre>
</div>

<p>
Another consequence is one ends up with less number of tasks total, so there's
less to choose from or pick what order to do things in.
</p>

<p>
A lot of the frustration behind the above rant comes from all the time I wasted
on <code>Patience I</code>, which I only got a partial solution to, and the exhaustion that
set in from solving the three-in-one task <a href="#org5285b32">Happy Farm</a>. As it were I felt really
burned out and didn't do anything at all productive on Sunday, except to assist
<code>poiko</code> with one of his solves. Well. I also discovered several mice in my
apartment this weekend, which was&#x2026;not fun.
</p>

<p>
Anyway, <code>aeshash</code> and <code>IEAIE</code> were both really cool, and I look forward to
actually doing them outside of the CTF.
</p>

<p>
We ended up placing 12th, so we just missed the mark for the coveted 13th
position.
</p>
</div>
</div>

<div id="outline-container-org5285b32" class="outline-3">
<h3 id="org5285b32">Happy Farm</h3>
<div class="outline-text-3" id="text-org5285b32">
<p>
A layered crypto task. It's simply the concatenation of three totally different
crypto tasks. Unlike some other such problems (I seem to remember some chained
RSA problem from either a Dragon CTF or a DefCon qualifier?) the systems here
aren't even related. In my opinion it really should have been given as three
separate tasks, even if they were capped at a third of the points.
</p>

<p>
But as it were, this took too much time and exhausted most of my energy/hype.
</p>

<p>
Also, the task had the added <i>fun flavour</i> of the code being about seeds and
fertilizers to grow onions, drawing numbers as ASCII-art bulbs and so forth. It
stopped being fun after the first subtask.
</p>
</div>

<div id="outline-container-orgd072804" class="outline-4">
<h4 id="orgd072804">Task 1: AES CBC</h4>
<div class="outline-text-4" id="text-orgd072804">
<p>
After spending some time reading the code (which is a hot mess) this task
becomes pretty simple. All you need to know is how CBC mode works with AES.
</p>

<p>
Your have an oracle you can query twice. You give it <code>(n, iv, data)</code> with
<code>n=0..8999</code> and it gives back \(\mathtt{aescbc}_{k,iv}^n(data)\) for an unknown key
\(k\). That is: AES is initialized in CBC mode with the unknown <code>k</code> and the given
<code>iv</code>. It then iteratively encrypt <code>data</code> <code>n</code> times. The goal is to
find \(\mathtt{aescbc}_{k,siv}^{9000}(sdata)\) for some known \((siv,sdata)\). You may
not give it \(sdata\) to encrypt directly.
</p>

<p>
So first you give it something like <code>(8999, siv[0]^sdata[0] || siv[1:], b'0' ||
sdata[1:])</code>. The xor is just to make the data not match <code>sdata</code>, but it will be
undone by the CBC mode. Then you give it <code>(1, response[-16:], response)</code> (last
block is the IV for next block) and the result is the answer.
</p>
</div>
</div>

<div id="outline-container-org79f10b0" class="outline-4">
<h4 id="org79f10b0">Task 2: RSA and Euler hacks</h4>
<div class="outline-text-4" id="text-org79f10b0">
<p>
The server sets \(e = 3\), \(s = (2^{1023})^e \pmod n\), and \(d = 1/3
\pmod{\phi(n)}\). \(n\) is composed of two 512-bit primes. Note that modulus \(n\) is
initially unknown. Note also that \(x^d \pmod n\) is "sort-of" like \(\sqrt[3]{x}
\pmod n\).
</p>

<p>
The serves gives you \(s\) and asks for an integer \(k \in [0,8999]\). It then gives
you \(r = s^{d^k}\), which is "sort-of" like taking the cube root \(k\) times.
</p>

<p>
Finally you can feed it a full pair \((x,j)\) and it will calculate \(y = x^{d^j}
\pmod n\) but with some of the low-order bits hidden. This whole thing was a bit
convoluted. There's ASCII drawings of onions that you use to figure out where
the missing bits are and blah blah. You basically
get \(y\) minus some "small" random number on the order of 2<sup>332</sup>-ish (if I
recall correctly). And a final caveat: the \(j\) you give in this step has to be
less than or equal to the \(k\) you gave initially.
</p>

<p>
The goal is to find \(s^{d^{9000}} \pmod n\).
</p>

<p>
First, to do anything, we need to find \(n\), which we can do with what I call
Euler hacks. We know that \(n' = 2^{3\cdot 1023} - s\) contains \(n\) as a factor.
This number is too big to try to factor out \(n\) directly, but we have another
number that also has \(n\) as a factor. Because \(r\) is "sort-of" like iteratively
taking the cube root of \(s\) (which was itself a cube, because \(e=3\)), if we
repeatedly cube it back up and subtract the known remainder we'll get a factor
of \(n\), for example in \(r^{3^{k-1}} - 2^{1023}\). This last number can't be
calculated directly if the \(k\) is large, but we can do it under \(\pmod{n'}\)
which will preserve the factor of \(n\). I suspect the caveat mentioned above with
\(j \le k\) is simply there to force you to give a large initial \(k\) to make this
step a little bit harder? Finally we take the <code>gcd</code> of these numbers and get <code>n</code>
(possibly multiplied by some small factor).
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #fb8512;">nk</span> = <span style="color: #6a7550;">2</span>**<span style="color: #bdbdb3;">(</span><span style="color: #6a7550;">3</span>*<span style="color: #6a7550;">3</span>*<span style="color: #6a7550;">11</span>*<span style="color: #6a7550;">31</span><span style="color: #bdbdb3;">)</span> - s
<span style="color: #fb8512;">nj</span> = <span style="color: #bdbdb3; font-weight: bold;">pow</span><span style="color: #bdbdb3;">(</span>r, <span style="color: #6a7550;">3</span>**<span style="color: #6a7550;">8997</span>, nk<span style="color: #bdbdb3;">)</span> - <span style="color: #6a7550;">2</span>**<span style="color: #bdbdb3;">(</span><span style="color: #6a7550;">11</span>*<span style="color: #6a7550;">31</span><span style="color: #bdbdb3;">)</span> <span style="color: #6abd50;"># </span><span style="color: #6aaf50;">I gave j=8999</span>
<span style="color: #fb8512;">n</span> = gcd<span style="color: #bdbdb3;">(</span>nk, nj<span style="color: #bdbdb3;">)</span>

<span style="color: #6abd50;"># </span><span style="color: #6aaf50;">The exponents are factored becaue I thought maybe the fact that 1023</span>
<span style="color: #6abd50;"># </span><span style="color: #6aaf50;">contained a factor of 3 would be relevant, but it wasn't.</span>
</pre>
</div>

<p>
Anyway, with \(n\) known this reduces to a lattice/Coppersmith-type problem. In
the second step I gave \(k=8999\) and got \(r = s^{d^{8999}} \pmod n\). In the last
step I gave \(j=8999\) again but now using \(x=2^{1023}\) as the base number (i.e. a
cube root of \(s\)), which gives me back \(y\) as an "approximation" of the target
number \(s^{d^{9000}} \pmod n\).
</p>

<p>
The mask for the unknown bits in this approximation is
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #fb8512;">mask</span> = <span style="color: #6a7550;">0xf00000000ffff0000ff00ffff00ffff00fffffffffffff000ffffffffffffffff00fffffffffffff0ff</span>
</pre>
</div>

<p>
Because \(y^3 = r \pmod n\) I can use this equation and Sage's <code>.small_roots()</code>. I
didn't really think about doing anything else, I just wanted it to end. However,
the missing bits are not contiguous: if treated as a contiguous block then it's
maybe a little bit over what a standard out-of-the-box Howgrave-Coppersmith
implementation can handle. I wanted to avoid introducing more variables for the
bit pattern and I also didn't want to sit there and have to fiddle with magic
parameters hoping to get lucky. But "brute forcing" the first hex
character seemed to be enough. E.g. in <code>sage</code>:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #7d7c61; font-weight: bold;">print</span><span style="color: #bdbdb3;">(</span><span style="color: #CC5542;">"small rootsin': "</span><span style="color: #bdbdb3;">)</span>
<span style="color: #7d7c61; font-weight: bold;">for</span> i <span style="color: #7d7c61; font-weight: bold;">in</span> <span style="color: #bdbdb3; font-weight: bold;">range</span><span style="color: #bdbdb3;">(</span><span style="color: #6a7550;">16</span><span style="color: #bdbdb3;">)</span>:
  <span style="color: #7d7c61; font-weight: bold;">print</span><span style="color: #bdbdb3;">(</span>i, end=<span style="color: #CC5542;">' '</span>, flush=<span style="color: #6a7550;">True</span><span style="color: #bdbdb3;">)</span>
  <span style="color: #fb8512;">rewt</span> = <span style="color: #bdbdb3;">(</span><span style="color: #6a9550;">(</span>c + i*<span style="color: #6a7550;">2</span>^<span style="color: #6a7550;">328</span> + x<span style="color: #6a9550;">)</span>^<span style="color: #6a7550;">3</span> - b<span style="color: #bdbdb3;">)</span>.small_roots<span style="color: #bdbdb3;">(</span>X=<span style="color: #6a7550;">2</span>**<span style="color: #6a7550;">300</span>, epsilon=<span style="color: #6a7550;">0</span>.<span style="color: #6a7550;">05</span><span style="color: #bdbdb3;">)</span>
  <span style="color: #7d7c61; font-weight: bold;">if</span> rewt:
    <span style="color: #7d7c61; font-weight: bold;">print</span><span style="color: #bdbdb3;">(</span><span style="color: #CC5542;">'thank god... You may now have a snack'</span><span style="color: #bdbdb3;">)</span>
    <span style="color: #7d7c61; font-weight: bold;">break</span>
</pre>
</div>

<p>
So <code>y + i*2^328 + rewt[0]</code> is the solution.
</p>
</div>
</div>

<div id="outline-container-org672dcfb" class="outline-4">
<h4 id="org672dcfb">Task 3: Borked RCA</h4>
<div class="outline-text-4" id="text-org672dcfb">
<p>
Thankfully, this last layer was very easy. By now I was really sick of this
whole task.
</p>

<p>
Long story short, you can query an oracle four times, giving it a <code>k</code> each time
(<code>k</code> has the usual constraints). It then does something like this:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #7d7c61; font-weight: bold;">def</span> <span style="color: #9b55c3;">blah</span><span style="color: #bdbdb3;">(</span>secret, k<span style="color: #bdbdb3;">)</span>:
  <span style="color: #fb8512;">L</span>,<span style="color: #fb8512;">R</span> = secret<span style="color: #bdbdb3;">[</span>:<span style="color: #bdbdb3; font-weight: bold;">len</span><span style="color: #6a9550;">(</span>secret<span style="color: #6a9550;">)</span>//<span style="color: #6a7550;">2</span><span style="color: #bdbdb3;">]</span>, secret<span style="color: #bdbdb3;">[</span><span style="color: #bdbdb3; font-weight: bold;">len</span><span style="color: #6a9550;">(</span>secret<span style="color: #6a9550;">)</span>//<span style="color: #6a7550;">2</span>:<span style="color: #bdbdb3;">]</span>
  <span style="color: #7d7c61; font-weight: bold;">for</span> _ <span style="color: #7d7c61; font-weight: bold;">in</span> <span style="color: #bdbdb3; font-weight: bold;">range</span><span style="color: #bdbdb3;">(</span>k<span style="color: #bdbdb3;">)</span>:
    <span style="color: #fb8512;">L</span>,<span style="color: #fb8512;">R</span> = R, bytes_xor<span style="color: #bdbdb3;">(</span>L, <span style="color: #7d7c61; font-weight: bold;">self</span>.rc4_encrypt<span style="color: #6a9550;">(</span>R<span style="color: #6a9550;">)</span><span style="color: #bdbdb3;">)</span>
  <span style="color: #7d7c61; font-weight: bold;">return</span> L+R
</pre>
</div>

<p>
And gives you the result. The goal is to find the result of <code>blah(secret,
9000**3)</code>.
</p>

<p>
<code>rc4_encrypt</code> is <i>supposed</i> to be a standard RC4 implementation initialized with
an unknown key. (I.e. it generates <code>len(plaintext)</code> bytes of stream cipher
output and xors it into the plaintext.) But if you're lucky like me, you notice
this little nugget right away, before you've even parsed what the task is about:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #7d7c61; font-weight: bold;">def</span> <span style="color: #9b55c3;">swap</span><span style="color: #bdbdb3;">(</span><span style="color: #7d7c61; font-weight: bold;">self</span>, a, b<span style="color: #bdbdb3;">)</span>:
  <span style="color: #fb8512;">a</span>, <span style="color: #fb8512;">b</span> = b, a
</pre>
</div>

<p>
I think I actually laughed when I saw this innocent little method. It's trying
so hard not to be noticed. Aww, it's so cute.
</p>

<p>
And but so. The RC4 implementation never really swaps elements around. Which means it
will have a really short order. Let's look at it:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #fb8512;">i</span> = <span style="color: #bdbdb3;">(</span>i + <span style="color: #6a7550;">1</span><span style="color: #bdbdb3;">)</span> % <span style="color: #6a7550;">256</span>
<span style="color: #fb8512;">j</span> = <span style="color: #bdbdb3;">(</span>j + s<span style="color: #6a9550;">[</span>i<span style="color: #6a9550;">]</span><span style="color: #bdbdb3;">)</span> % <span style="color: #6a7550;">256</span>
<span style="color: #7d7c61; font-weight: bold;">self</span>.swap<span style="color: #bdbdb3;">(</span>s<span style="color: #6a9550;">[</span>i<span style="color: #6a9550;">]</span>, s<span style="color: #6a9550;">[</span>j<span style="color: #6a9550;">]</span><span style="color: #bdbdb3;">)</span> <span style="color: #6abd50;"># </span><span style="color: #6aaf50;">lol!</span>
output.append<span style="color: #bdbdb3;">(</span>s<span style="color: #6a9550;">[</span><span style="color: #baba36;">(</span>s<span style="color: #9b55c3;">[</span>i<span style="color: #9b55c3;">]</span> + s<span style="color: #9b55c3;">[</span>j<span style="color: #9b55c3;">]</span><span style="color: #baba36;">)</span> % <span style="color: #6a7550;">256</span><span style="color: #6a9550;">]</span><span style="color: #bdbdb3;">)</span>
</pre>
</div>

<p>
Every 256 iterations, the <code>i</code> will be 0 and <code>j</code> will be <code>sum(range(256))%256 ==
128</code>. Meaning that every <i>512</i> iterations we'll have \(j=i=0\) and it will repeat.
</p>

<p>
OK. So. It's trivial to find <code>secret</code>: just give it <code>k=0</code> and it won't encrypt
it. I think <code>secret</code> was 240 bytes long, so to find the order of <code>blah</code> we just
need to align things&#x2026;lcm with the order&#x2026;hm divide by 2&#x2026;blah blah boring
details. Long story short, <code>blah(secret, 9000**3) == secret</code>. It's just what
came out of the first oracle query. Almost a bit of an anti-climax, really.
</p>
</div>
</div>
</div>

<div id="outline-container-org68f9025" class="outline-3">
<h3 id="org68f9025">The Last Bitcoin</h3>
<div class="outline-text-3" id="text-org68f9025">
<p>
Proof-of-work Python script that asks you to find a string <code>X</code> such that <code>sha256(random_token +
X)</code> starts with 200 zero bits.
</p>

<p>
That part is straightforward and clearly impossible.
</p>

<p>
Then you notice that if you give it such a string it exits with error code 1
indicating success. Python also exists with 1 if it gets an uncaught exception.
And it will give such an exception if you give it non-ascii input. So I simply
typed <code></code> and got the flag.
</p>
</div>
</div>

<div id="outline-container-org4231ac6" class="outline-3">
<h3 id="org4231ac6">The Danger of Google's Omnipotence</h3>
<div class="outline-text-3" id="text-org4231ac6">
<p>
This is really <code>poiko</code>'s solve, he did the reverse, provided all the data, and so
on, I just helped with the last part in figuring out how to reduce the magic
operation to something tractable.
</p>

<p>
The problem at bird's eye is, I was told, something like this:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #fb8512;">k</span> = <span style="color: #6a7550;">0xfad9c53c828be5dafc765d4a52a54168442b6f57569db5f320a45d0d0e39d92d04284087fe2e36da1375d55e6e4e9f746cf9d9916c791e0467dc0aedf77581d7e1ab342f99e49f4c684fd7424e806cc2fb1dd54c614487b6a3909dc469f76eb8df050f3928d4c371d8aace5c81fbb1e467b987ec5ae1f5ecd0b8ffe69369edc9</span>
<span style="color: #fb8512;">flag</span> = &lt;some <span style="color: #6a7550;">2</span>^<span style="color: #6a7550;">16</span> array&gt; <span style="color: #6abd50;"># </span><span style="color: #6aaf50;">secret</span>
<span style="color: #fb8512;">A</span> = &lt;some <span style="color: #6a7550;">2</span>^<span style="color: #6a7550;">16</span> array&gt; <span style="color: #6abd50;"># </span><span style="color: #6aaf50;">known</span>

<span style="color: #fb8512;">B</span> = flag
<span style="color: #7d7c61; font-weight: bold;">for</span> _ <span style="color: #7d7c61; font-weight: bold;">in</span> <span style="color: #bdbdb3; font-weight: bold;">range</span><span style="color: #bdbdb3;">(</span>k<span style="color: #bdbdb3;">)</span>:
  <span style="color: #fb8512;">B</span> = strange_matmul<span style="color: #bdbdb3;">(</span>B, A<span style="color: #bdbdb3;">)</span>

<span style="color: #6abd50;"># </span><span style="color: #6aaf50;">B is output here</span>
</pre>
</div>

<p>
Reversing <code>strange_matmul</code> and figuring out what it does is the main problem,
which <code>poiko</code> already did. But as a last step we'd need to strength-reduce
<code>strange_matmul</code> to some actual math, like a real matrix multiplication for
example, and then we have <code>B = flag * A^k</code> which can hopefully be inverted.
</p>

<p>
<code>poiko</code> gave me sort-of pseudocode for <code>strange_matmul</code>:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #7d7c61; font-weight: bold;">def</span> <span style="color: #9b55c3;">strange_matmul</span><span style="color: #bdbdb3;">(</span>m, n<span style="color: #bdbdb3;">)</span>:
    <span style="color: #fb8512;">out</span> = <span style="color: #bdbdb3;">[]</span>
    <span style="color: #7d7c61; font-weight: bold;">for</span> i <span style="color: #7d7c61; font-weight: bold;">in</span> <span style="color: #bdbdb3; font-weight: bold;">range</span><span style="color: #bdbdb3;">(</span><span style="color: #6a7550;">256</span><span style="color: #bdbdb3;">)</span>:
        <span style="color: #7d7c61; font-weight: bold;">for</span> j <span style="color: #7d7c61; font-weight: bold;">in</span> <span style="color: #bdbdb3; font-weight: bold;">range</span><span style="color: #bdbdb3;">(</span><span style="color: #6a7550;">256</span><span style="color: #bdbdb3;">)</span>:
            <span style="color: #fb8512;">val</span> = <span style="color: #6a7550;">0</span>
            <span style="color: #7d7c61; font-weight: bold;">for</span> k <span style="color: #7d7c61; font-weight: bold;">in</span> <span style="color: #bdbdb3; font-weight: bold;">range</span><span style="color: #bdbdb3;">(</span><span style="color: #6a7550;">256</span><span style="color: #bdbdb3;">)</span>:
                <span style="color: #fb8512;">v1</span> = m<span style="color: #bdbdb3;">[</span>i*<span style="color: #6a7550;">256</span>+k<span style="color: #bdbdb3;">]</span>
                <span style="color: #fb8512;">v2</span> = n<span style="color: #bdbdb3;">[</span>k*<span style="color: #6a7550;">256</span>+j<span style="color: #bdbdb3;">]</span>
                <span style="color: #7d7c61; font-weight: bold;">if</span> v1 == <span style="color: #6a7550;">0</span> <span style="color: #7d7c61; font-weight: bold;">or</span> v2 == <span style="color: #6a7550;">0</span>:
                    <span style="color: #7d7c61; font-weight: bold;">continue</span>
                <span style="color: #fb8512;">val</span> = strange_add<span style="color: #bdbdb3;">(</span>val, a_inv<span style="color: #6a9550;">[</span><span style="color: #baba36;">(</span>a<span style="color: #9b55c3;">[</span>v1<span style="color: #9b55c3;">]</span> + a<span style="color: #9b55c3;">[</span>v2<span style="color: #9b55c3;">]</span><span style="color: #baba36;">)</span> % <span style="color: #6a7550;">7</span>**<span style="color: #6a7550;">3</span><span style="color: #6a9550;">]</span><span style="color: #bdbdb3;">)</span>
            out.append<span style="color: #bdbdb3;">(</span>val<span style="color: #bdbdb3;">)</span>
    <span style="color: #7d7c61; font-weight: bold;">return</span> out
</pre>
</div>

<p>
Where <code>strange_add</code> adds the numbers as if they were in base-7 but without using
carry, and <code>a</code> and <code>a_inv</code> were some lookup tables he also shared. I don't
remember if they were in the code or something he constructed.
</p>

<p>
Anyway, so it looks like a normal matrix multiplication, but the element-wise
operations aren't carried out using normal arithmetic. So we both played around
a little with <code>a</code> and <code>a_inv</code> and there were definite group-like properties. I
even wrote a little utility class so I could do arithmetic with such numbers
directly and play with them in the REPL. At first it "felt" like a commutative
additive group, with <code>0</code> almost being the identity except for <code>0 + 0 = 1</code> which
meant it wasn't really associative either, because \((x+0)+0 \ne x+(0+0)\). <code>a</code>
was a permulation, but <code>a_inv</code> was not as <code>a_inv[0] == 1</code> when it seemed like it
should have been 0. This makes sense from the above code where 0 is avoided.
Anyway, from the <code>strange_add</code> I strongly suspected it was a mapping into the
ker<sup><a id="fnr.14" class="footref" href="#fn.14">14</a></sup> \(\mathbb{F}_{7^3}\) where the numbers represented the coefficients of
a qudratic polynomial over \(\mathbb{F}_{7}\). If so, what's the modulus?
</p>

<p>
\(x^3\) in \(\mathbb{F}_{7}[X]/(x^3 + P)\) should become \(-P\) where \(deg P < 3\).
</p>

<div class="org-src-container">
<pre class="src src-python">&gt;&gt;&gt; -fux<span style="color: #bdbdb3;">(</span><span style="color: #6a7550;">7</span><span style="color: #bdbdb3;">)</span>**<span style="color: #6a7550;">3</span>
<span style="color: #bdbdb3;">[</span><span style="color: #6a7550;">6</span> <span style="color: #6a7550;">0</span> <span style="color: #6a7550;">4</span><span style="color: #bdbdb3;">]</span>
</pre>
</div>

<p>
<code>fux</code> was my utility-class, and <code>fux(7)</code> should represent <code>x</code>, so the modulus is
\(x^3 + 6 x^2 + 4\). (It turns out to also be the default one that <code>sage</code> gives
when constructing <code>GF(7^3)</code>, so that's probably its origin.) With this intuition
behind it the math seems to work out.
</p>

<p>
So, we had 256x256 matrices over \(\mathbb{F}_{7^3}\), and calculating the inverse
is straightforward but boring <code>sage</code> stuff. It would likely have taken many
minutes though, but one thing I lucked out<sup><a id="fnr.15" class="footref" href="#fn.15">15</a></sup> on was I did
<code>.multiplicative_order()</code> on <code>A^-1</code> which <code>sage</code> found quickly as 342. So I
could shave several minutes off the calculation by doing <code>flagimg = B*(A^-1)^(k
% 342)</code>.
</p>

<p>
Anyway, <code>flagimg</code> was a 256x256 noisy image showing a readable flag.
</p>
</div>
</div>

<div id="outline-container-orgd28210c" class="outline-3">
<h3 id="orgd28210c">aeshash &amp; IEAIE &amp; Patience I</h3>
<div class="outline-text-3" id="text-orgd28210c">
<p>
I feel these deserve an entry even though I failed all of them, but I did spend
time on them. I probably didn't praise the first two tasks in this list enough.
They are what I consider actually <i>good</i> crypto tasks of high difficulty (unlike
<a href="#org5285b32">Happy Farm</a>). Especially <code>aeshash</code>! <code>aeshash</code>'s task author deserves some real
kudos.
</p>

<p>
For either task I had no prior experience and tooling, so I knew it'd be a lot
of work for me. I made <code>poiko</code> waste some of his rev-time to make sure I got a
<code>aeshash</code> into Python, which I felt sort of bad about&#x2026; Because I only really
started to scratch the surface of them. And then for most of Sunday I didn't
really have any energy left to continue. However they're the kind of tasks that
makes me want to solve them in my leisure time, which is a real treat.
</p>

<p>
<code>IEAIE</code> was some image encryption scheme using a logistic map and permuations.
It was very sensitive to differential analysis. I did a few things, was able to
reveal a bunch of key-state, but ran into some floating point rounding headaches
in my offline tests. I hate floating point numbers, so I took a sanity break
from it and never really got back. For once the relevant papers are given in the
task description so it's not really a Google-the-Paper challenge.
</p>

<p>
<code>aeshash</code> involved leaking state in a three-round pseudo-AES (each round using
initial state as round-key) and then targeting a specific output. Literally: an
AES hash. I have no idea about this one, which is all the more exciting. Despite
me usually solving the crypto challenges I've never worked with crypto
profesionally or academically, so I lack a ton of basic knowledge and
experience, such as breaking weakened AES, which is probably like Crypto 101.
But I figured it will be a good place to start learning.
</p>

<p>
I also sunk a ton of time into <code>Patience I</code> doing proper OpenCV for the first
time in my life&#x2026; God, this task sapped me. The composed text which I suspect
is one third of the flag(?) was easy, I also found this strange Morse-ish
sequence but was unable to guess what it really was, noted the spikes in the
lighting but had no idea what they meant either. In the end I even started to
fear the minute little camera shakes were also part of it. Please God. Maybe all
of these things played together in some beautiful and harmonious way in the end,
but really it just felt like three concatenated subtasks that just all had to do
with video?
</p>

<p>
<i>Addendum:</i> having seen spoilers on how <code>Patience I</code> is solved (but not the
others), I can at least say I don't feel bad anymore for not figuring out this
task. It's a bad one. Though I was wrong about the "subtasks" being separate.
</p>

<p>
The first string you find, the easy part, overlay all the LEDs, was
<code>_q!fitlboEc</code>. I mistakenly thought it might be <code>flag[x::3]</code> or something like
that. (Thus why I thought the three parts were separate.) But apparently it's an
alphabet of sorts, which you index using&#x2026;I don't know, it was unclear exactly
what. And the timing pattern <i>was</i> Morse, but the international extended version
with punctuation, making <code>P=B_=_Q=D</code> which is apparently supposed to mean
"replace 'b' with 'p', and 'q' with 'q'"?&#x2026; The logic or motivation behind any
of these things totally escapes me.
</p>

<p>
I even said to <code>poiko</code> while I was working on this task, thinks like "hm,
there's a timing pattern here, it feels a lot like Morse, but I'm actually going
to be a little bit disappointed if that turns out to be true&#x2026;" and "it can't
be too escape room-ish, right? It's Balsn, they're good, they wouldn't make
something like that" and so on. <a href="https://www.youtube.com/watch?v=_O1hM-k3aUY">Disappointed!</a>
</p>
</div>
</div>

<div id="outline-container-org138ec7b" class="outline-3">
<h3 id="org138ec7b">babyrev</h3>
<div class="outline-text-3" id="text-org138ec7b">
<p>
Again, <code>poiko</code> solved this one, but I helped out a tiny little bit at the end, so I
feel comfortable writing what it was about.
</p>

<p>
Apparently a <code>scala</code> program that seemed to construct an infinite stream by
doing what I would write in Haskell as:
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #9b55c3;">w</span> <span style="color: #fb8512;">=</span> <span style="color: #bdbdb3;">[</span><span style="color: #6a9550;">[</span><span style="color: #6a7550;">0</span>,<span style="color: #6a7550;">1</span>,<span style="color: #6a7550;">2</span>,<span style="color: #6a7550;">3</span><span style="color: #6a9550;">]</span>, <span style="color: #6a9550;">[</span><span style="color: #6a7550;">0</span><span style="color: #6a9550;">]</span>, <span style="color: #6a9550;">[</span><span style="color: #6a7550;">0</span><span style="color: #6a9550;">]</span>, <span style="color: #6a9550;">[</span><span style="color: #6a7550;">0</span><span style="color: #6a9550;">]</span><span style="color: #bdbdb3;">]</span>
<span style="color: #9b55c3;">stream</span> <span style="color: #fb8512;">=</span> <span style="color: #bdbdb3;">[</span><span style="color: #6a7550;">0</span><span style="color: #bdbdb3;">]</span> <span style="color: #528fd1;">:</span> map <span style="color: #bdbdb3;">(</span>concat <span style="color: #fb8512;">.</span> map <span style="color: #6a9550;">(</span>w <span style="color: #fb8512;">!!</span><span style="color: #6a9550;">)</span><span style="color: #bdbdb3;">)</span> stream
</pre>
</div>

<p>
It makes an infinite stream of lists like <code>[0] : [0,1,2,3] : [0,1,2,3,0,0,0] :
[0,1,2,3,0,0,0,0,1,2,3,0,1,2,3,0,1,2,3] : ...</code>. It sums all the sublists in this
stream, extracts index 60107, and takes its remainder under \(2^{62}\). It
converts the resulting number to 4 bytes which becomes an xor-key for flag data.
</p>

<p>
Immediately I smelled a recurrence relation for the sum. Tried and true OEIS tells the
truth: \(a_{n+2} = a_{n+1} + 3 a_{n}\) <sup><a id="fnr.16" class="footref" href="#fn.16">16</a></sup>, and so, starting from \(a_0 = 0\) and \(a_1 =
6\) (for the sum of these lists) gives all that's needed. It can be calculated
linearly in a list, or logarithmically by exponentiation on a 2x2 matrix.
</p>
</div>
</div>
</div>


<div id="outline-container-org950d79a" class="outline-2">
<h2 id="org950d79a">DragonCTF 2020</h2>
<div class="outline-text-2" id="text-org950d79a">
</div>
<div id="outline-container-org79f910e" class="outline-3">
<h3 id="dragon2020"><a id="org79f910e"></a>General Comments</h3>
<div class="outline-text-3" id="text-dragon2020">
<p>
My expectations were a bit high, DragonCTF has had some of the best CTFs in the
past. Yet I had the thought that even last year's 24-hour "teaser" CTF was
better? So a bit mixed feelings. I'm not saying this wasn't good but&#x2026;? It's
hard not to vote with one's heart.
</p>

<p>
The difficulty was alright, but it felt like very few tasks in total. Thinking
partly of my poor teammate <code>poiko</code> this time, who seemed to get only a single
pure rev task, and an easy one at that. I know he was hyped and had looked
forward to fiendish VM-in-VMs and unknown architectures. We kept waiting for
more to be released, but alas.
</p>

<p>
For my own sake, <a href="#org5b5da77">Frying in motion</a> was an cool idea, tho a bit draining. <a href="#org2733f80">Bit Flip 1</a> was easy. <a href="#orgd34d048">Bit Flip 2 &amp; 3</a> were puzzling, but not the good kind of
puzzling (which motivates me to write code or learn stuff outside of the CTF),
but "I feel I just missing some (probably) trivial trick here, oh well next time
I guess" puzzling.
</p>

<p>
Sunday I ended up watching <i>Gilmore Girls</i> and <code>poiko</code> was reduced to doing
Linux stuff and actual hacking. Imagine having to do actual hacking. What's that
about? Sheesh.
</p>

<p>
Anyway, we placed like dumpster tier anyway. Wasn't our weekend, I guess.
</p>
</div>
</div>

<div id="outline-container-org5b5da77" class="outline-3">
<h3 id="org5b5da77">Frying in motion</h3>
<div class="outline-text-3" id="text-org5b5da77">
<p>
I put off this task while looking at the <i>Bit Flip</i> tasks because I kind of
expected implementing it would be an unfun hellhole of tiny bugs. It's one of
those tasks where the idea is simple and/or obvious but it's a pain in the ass
to implement<sup><a id="fnr.17" class="footref" href="#fn.17">17</a></sup>. Not a fan of that.
</p>

<p>
But so: the task involves reversing a <code>strfry()</code> given the output of another
<code>strfry()</code>. Fine, sounds like an RNG task.
</p>

<p>
<code>strfry()</code> does this:
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #528fd1;">char</span> *
<span style="color: #9b55c3;">strfry</span> <span style="color: #bdbdb3;">(</span><span style="color: #528fd1;">char</span> *<span style="color: #fb8512;">string</span><span style="color: #bdbdb3;">)</span>
<span style="color: #bdbdb3;">{</span>
  <span style="color: #7d7c61; font-weight: bold;">static</span> <span style="color: #528fd1;">int</span> <span style="color: #fb8512;">init</span>;
  <span style="color: #7d7c61; font-weight: bold;">static</span> <span style="color: #7d7c61; font-weight: bold;">struct</span> <span style="color: #528fd1;">random_data</span> <span style="color: #fb8512;">rdata</span>;

  <span style="color: #7d7c61; font-weight: bold;">if</span> <span style="color: #6a9550;">(</span><span style="color: #7d7c61; font-weight: bold;">!</span>init<span style="color: #6a9550;">)</span>
    <span style="color: #6a9550;">{</span>
      <span style="color: #7d7c61; font-weight: bold;">static</span> <span style="color: #528fd1;">char</span> <span style="color: #fb8512;">state</span><span style="color: #baba36;">[</span><span style="color: #6a7550;">32</span><span style="color: #baba36;">]</span>;
      rdata.state = <span style="color: #6a7550;">NULL</span>;
      __initstate_r <span style="color: #baba36;">(</span>random_bits <span style="color: #9b55c3;">()</span>,
                     state, <span style="color: #7d7c61; font-weight: bold;">sizeof</span> <span style="color: #9b55c3;">(</span>state<span style="color: #9b55c3;">)</span>, &amp;rdata<span style="color: #baba36;">)</span>;
      init = <span style="color: #6a7550;">1</span>;
    <span style="color: #6a9550;">}</span>

  <span style="color: #528fd1;">size_t</span> <span style="color: #fb8512;">len</span> = strlen <span style="color: #6a9550;">(</span>string<span style="color: #6a9550;">)</span>;
  <span style="color: #7d7c61; font-weight: bold;">if</span> <span style="color: #6a9550;">(</span>len &gt; <span style="color: #6a7550;">0</span><span style="color: #6a9550;">)</span>
    <span style="color: #7d7c61; font-weight: bold;">for</span> <span style="color: #6a9550;">(</span><span style="color: #528fd1;">size_t</span> <span style="color: #fb8512;">i</span> = <span style="color: #6a7550;">0</span>; i &lt; len - <span style="color: #6a7550;">1</span>; ++i<span style="color: #6a9550;">)</span>
      <span style="color: #6a9550;">{</span>
        <span style="color: #528fd1;">int32_t</span> <span style="color: #fb8512;">j</span>;
        __random_r <span style="color: #baba36;">(</span>&amp;rdata, &amp;j<span style="color: #baba36;">)</span>;
        j = j % <span style="color: #baba36;">(</span>len - i<span style="color: #baba36;">)</span> + i;

        <span style="color: #528fd1;">char</span> <span style="color: #fb8512;">c</span> = string<span style="color: #baba36;">[</span>i<span style="color: #baba36;">]</span>;
        string<span style="color: #baba36;">[</span>i<span style="color: #baba36;">]</span> = string<span style="color: #baba36;">[</span>j<span style="color: #baba36;">]</span>;
        string<span style="color: #baba36;">[</span>j<span style="color: #baba36;">]</span> = c;
      <span style="color: #6a9550;">}</span>

  <span style="color: #7d7c61; font-weight: bold;">return</span> string;
<span style="color: #bdbdb3;">}</span>
</pre>
</div>

<p>
(Aside: is it just me or is the GNU style one of the ugliest code styles in
existence?)
</p>

<p>
So <code>strfry()</code> just uses glibc's <code>random_r()</code> stuff, using a 32-byte state
buffer (of which only 28 bytes are used), initialized with a 32-bit seed based
on some CPU clock counter. (<code>random_bits()</code> actually gives less than 32-bits of
actual bits but let's ignore that.)
</p>

<p>
It's clearly a "brute the seed" sort of task, because reversing the internal
state directly (let's say if it had initialized with 28 bytes of random data
from <code>urandom</code>) just given <code>strfry()</code> output alone is very hard unless many
such calls can be queried in a series. (And even then it would be a finicky as
all hell.)
</p>

<p>
Another thing the task does is it calls <code>strfry()</code> a lot of times on a temporary
string before it does the challenge-response step. The number of resulting
<code>random_r()</code> calls is predictable, but you don't get any output. So, it's "brute
the seed" and then "seek in the RNG stream."
</p>

<p>
Seeking in glibc's <code>random_r()</code> stream turns out to be easy, as it seems to be
just a linear recurrence. It does varying things depending on how many bytes of
state you give it, but all of them are very simple. It's sort of like a more
flexible Mersenne Twister without the output scrambling. For 32-byte state it
will use \(a_{n+7} = a_{n+4} + a_n\) which can be modelled most simply (to me,
anyway) with matrix exponentiation:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #fb8512;">A</span> = ZZ<span style="color: #bdbdb3;">[</span><span style="color: #6a7550;">2</span>**<span style="color: #6a7550;">32</span><span style="color: #bdbdb3;">]</span>.matrix<span style="color: #bdbdb3;">(</span><span style="color: #6a9550;">[</span><span style="color: #baba36;">[</span><span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">1</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">1</span><span style="color: #baba36;">]</span>,
                      <span style="color: #baba36;">[</span><span style="color: #6a7550;">1</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span><span style="color: #baba36;">]</span>,
                      <span style="color: #baba36;">[</span><span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">1</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span><span style="color: #baba36;">]</span>,
                      <span style="color: #baba36;">[</span><span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">1</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span><span style="color: #baba36;">]</span>,
                      <span style="color: #baba36;">[</span><span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">1</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span><span style="color: #baba36;">]</span>,
                      <span style="color: #baba36;">[</span><span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">1</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span><span style="color: #baba36;">]</span>,
                      <span style="color: #baba36;">[</span><span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">0</span>, <span style="color: #6a7550;">1</span>, <span style="color: #6a7550;">0</span><span style="color: #baba36;">]</span><span style="color: #6a9550;">]</span><span style="color: #bdbdb3;">)</span>

<span style="color: #6abd50;"># </span><span style="color: #6aaf50;">now you can model state after n steps as A**n * state</span>
<span style="color: #6abd50;"># </span><span style="color: #6aaf50;">modulo indexing errors.</span>
</pre>
</div>

<p>
This is the same for seeking in plenty of RNGs whose internals are linear or
"affine" like xoshiro and MT. Note that the state has the last 7 outputs from
the RNG, which will come in handy. Note also that the RNG discard the lowest
bit when giving actual output. (But due to the lack of scrambling the low order
bits will still be pretty bad by most RNG standards.)
</p>

<p>
Now about the seed. The state is initialized by <code>initstate_r()</code> with \(state_i =
 seed \cdot 16807^i \pmod {2^{31}-1}\).
</p>

<p>
There's plenty of sources of bugs here. One is that it actually starts
outputting at \(state_3\) or something like that(?). It also discards the 70 (in
our case) first outputs from <code>random_r()</code> so these have to be taken into
account. And of course the mixed moduli need to be kept separate.
</p>

<p>
Now to match the <code>strfry()</code> output. For example, given <code>out = strfry(in)</code> with
unique characters, I know that the first random call satisfies <code>random_r() %
 len(in) == in.index(out[0])</code>. Then re-do the swap, and get a similar constraint
on the next call, and so forth. I did this for the 7 first characters for a 90+
char string to make sure I had enough information to uniquely determine any
seed from a given state.
</p>

<p>
I think in the end I had some idiotic thing like:
</p>

<p>
\(( A^{70+n+7} \left[ seed \cdot 16807^i \pmod {2^{31}-1} \right]_{i=0\ldots 6} \pmod {2^{32}})_{7-j} \gg
 1 = index_{j} \pmod {length - j} \pmod {\mathtt{random\_indexing\_errors}}\)
</p>

<p>
I mean&#x2026; It's not pretty. I knew it wouldn't be. Doing this sort of thing 90%
of my time is spent fixing off-by-one errors or putting indices in the wrong
order or something like that. For my test code I had something like:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #fb8512;">start</span> = np.array<span style="color: #bdbdb3;">(</span><span style="color: #6a9550;">[</span><span style="color: #6a7550;">282475249</span>, <span style="color: #6a7550;">16807</span>, <span style="color: #6a7550;">1</span>, <span style="color: #6a7550;">470211272</span>, <span style="color: #6a7550;">1144108930</span>, <span style="color: #6a7550;">984943658</span>, <span style="color: #6a7550;">1622650073</span><span style="color: #6a9550;">]</span>, np.uint32<span style="color: #bdbdb3;">)</span>
<span style="color: #fb8512;">A</span> = np.array<span style="color: #bdbdb3;">(</span><span style="color: #6a9550;">[</span>
  <span style="color: #baba36;">[</span><span style="color: #6a7550;">0xe9373f80</span>, <span style="color: #6a7550;">0xdc7dfb8c</span>, <span style="color: #6a7550;">0x9a732dfd</span>, <span style="color: #6a7550;">0x8e41234d</span>, <span style="color: #6a7550;">0x45478090</span>, <span style="color: #6a7550;">0xe4134087</span>, <span style="color: #6a7550;">0x78b11946</span><span style="color: #baba36;">]</span>,
  <span style="color: #baba36;">[</span><span style="color: #6a7550;">0x78b11946</span>, <span style="color: #6a7550;">0xe9373f80</span>, <span style="color: #6a7550;">0xdc7dfb8c</span>, <span style="color: #6a7550;">0x21c214b7</span>, <span style="color: #6a7550;">0x8e41234d</span>, <span style="color: #6a7550;">0x45478090</span>, <span style="color: #6a7550;">0xe4134087</span><span style="color: #baba36;">]</span>,
  <span style="color: #baba36;">[</span><span style="color: #6a7550;">0xe4134087</span>, <span style="color: #6a7550;">0x78b11946</span>, <span style="color: #6a7550;">0xe9373f80</span>, <span style="color: #6a7550;">0xf86abb05</span>, <span style="color: #6a7550;">0x21c214b7</span>, <span style="color: #6a7550;">0x8e41234d</span>, <span style="color: #6a7550;">0x45478090</span><span style="color: #baba36;">]</span>,
  <span style="color: #baba36;">[</span><span style="color: #6a7550;">0x45478090</span>, <span style="color: #6a7550;">0xe4134087</span>, <span style="color: #6a7550;">0x78b11946</span>, <span style="color: #6a7550;">0xa3efbef0</span>, <span style="color: #6a7550;">0xf86abb05</span>, <span style="color: #6a7550;">0x21c214b7</span>, <span style="color: #6a7550;">0x8e41234d</span><span style="color: #baba36;">]</span>,
  <span style="color: #baba36;">[</span><span style="color: #6a7550;">0x8e41234d</span>, <span style="color: #6a7550;">0x45478090</span>, <span style="color: #6a7550;">0xe4134087</span>, <span style="color: #6a7550;">0xea6ff5f9</span>, <span style="color: #6a7550;">0xa3efbef0</span>, <span style="color: #6a7550;">0xf86abb05</span>, <span style="color: #6a7550;">0x21c214b7</span><span style="color: #baba36;">]</span>,
  <span style="color: #baba36;">[</span><span style="color: #6a7550;">0x21c214b7</span>, <span style="color: #6a7550;">0x8e41234d</span>, <span style="color: #6a7550;">0x45478090</span>, <span style="color: #6a7550;">0xc2512bd0</span>, <span style="color: #6a7550;">0xea6ff5f9</span>, <span style="color: #6a7550;">0xa3efbef0</span>, <span style="color: #6a7550;">0xf86abb05</span><span style="color: #baba36;">]</span>,
  <span style="color: #baba36;">[</span><span style="color: #6a7550;">0xf86abb05</span>, <span style="color: #6a7550;">0x21c214b7</span>, <span style="color: #6a7550;">0x8e41234d</span>, <span style="color: #6a7550;">0x4cdcc58b</span>, <span style="color: #6a7550;">0xc2512bd0</span>, <span style="color: #6a7550;">0xea6ff5f9</span>, <span style="color: #6a7550;">0xa3efbef0</span><span style="color: #baba36;">]</span>,
<span style="color: #6a9550;">]</span>, np.uint32<span style="color: #bdbdb3;">)</span>

<span style="color: #528fd1;">@numba.jit</span><span style="color: #bdbdb3;">(</span>nopython=<span style="color: #6a7550;">True</span><span style="color: #bdbdb3;">)</span>
<span style="color: #7d7c61; font-weight: bold;">def</span> <span style="color: #9b55c3;">find_seed</span><span style="color: #bdbdb3;">(</span>A, start, m<span style="color: #bdbdb3;">)</span>:
  <span style="color: #fb8512;">seedvec</span> = start.copy<span style="color: #bdbdb3;">()</span>
  <span style="color: #7d7c61; font-weight: bold;">for</span> i <span style="color: #7d7c61; font-weight: bold;">in</span> <span style="color: #bdbdb3; font-weight: bold;">range</span><span style="color: #bdbdb3;">(</span><span style="color: #6a7550;">1</span>,<span style="color: #6a7550;">2</span>**<span style="color: #6a7550;">32</span><span style="color: #bdbdb3;">)</span>:
    <span style="color: #fb8512;">out</span> = <span style="color: #bdbdb3;">(</span>A*seedvec<span style="color: #bdbdb3;">)</span>.<span style="color: #bdbdb3; font-weight: bold;">sum</span><span style="color: #bdbdb3;">(</span><span style="color: #6a7550;">1</span><span style="color: #bdbdb3;">)</span>.astype<span style="color: #bdbdb3;">(</span>np.uint32<span style="color: #bdbdb3;">)</span>
    <span style="color: #fb8512;">out</span> //= <span style="color: #6a7550;">2</span>
    <span style="color: #fb8512;">out</span> %= np.array<span style="color: #bdbdb3;">(</span><span style="color: #bdbdb3; font-weight: bold;">range</span><span style="color: #6a9550;">(</span><span style="color: #6a7550;">89</span>,<span style="color: #6a7550;">96</span><span style="color: #6a9550;">)</span>, np.uint32<span style="color: #bdbdb3;">)</span>
    <span style="color: #7d7c61; font-weight: bold;">if</span> np.<span style="color: #bdbdb3; font-weight: bold;">all</span><span style="color: #bdbdb3;">(</span>out == m<span style="color: #bdbdb3;">)</span>:
      <span style="color: #7d7c61; font-weight: bold;">return</span> i
    <span style="color: #fb8512;">seedvec</span> += start
    <span style="color: #fb8512;">seedvec</span> %= <span style="color: #6a7550;">2147483647</span>
</pre>
</div>

<p>
However, doing a full brute like this wasn't fast enough against the live
server. It was really close but it required me to get lucky, and DragonCTF has
this super annoying PoW blocker on all their tasks&#x2026; I probably should have
picked apart <code>random_bits()</code> but at this point I just wanted to move on with my
life. I <i>think</i> it might also be possible to thread the various moduli and
simply <i>calculate the seed directly</i> for each index-modulus and then CRT it,
but Lord almighty, the paper work involved. Yeah, brute forcing is dirty, it
doesn't feel rewarding or clean, but it's a dirty real-worldsy task.
</p>

<p>
But because this CTF had like 1 rev task, <code>poiko</code> was free to help out, so he
wrote a utility in big boy code to do the above for me while I fixed the
remaining indexical bugs.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #7d7c61; font-weight: bold;">print</span><span style="color: #bdbdb3;">(</span><span style="color: #CC5542;">"FINDING SEED VROOM VROOM"</span><span style="color: #bdbdb3;">)</span>
<span style="color: #fb8512;">s</span> = <span style="color: #bdbdb3; font-weight: bold;">int</span><span style="color: #bdbdb3;">(</span>subprocess.getoutput<span style="color: #6a9550;">(</span><span style="color: #CC5542;">'./BLAS '</span> + <span style="color: #CC5542;">' '</span>.join<span style="color: #baba36;">(</span><span style="color: #bdbdb3; font-weight: bold;">str</span><span style="color: #9b55c3;">(</span>x<span style="color: #9b55c3;">)</span> <span style="color: #7d7c61; font-weight: bold;">for</span> x <span style="color: #7d7c61; font-weight: bold;">in</span> M<span style="color: #baba36;">)</span><span style="color: #6a9550;">)</span><span style="color: #bdbdb3;">)</span>
<span style="color: #6abd50;"># </span><span style="color: #6aaf50;">s = find_seed(M)</span>
</pre>
</div>

<p>
Out comes the seed quick as mercury rain. Then seek the stream as above, then
seek the stream again because you forgot to add +1, then do the final
<code>strfry()</code> on the given string, then realize you're an idiot and <i>reverse</i> the
final <code>strfry()</code> because you misremembered the code, then finally get the flag.
</p>
</div>
</div>

<div id="outline-container-org2733f80" class="outline-3">
<h3 id="org2733f80">Bit Flip 1</h3>
<div class="outline-text-3" id="text-org2733f80">
<p>
Diffie-Hellman between Alice and Bob to get a shared key which is used as an AES key.
</p>

<p>
The stream of numbers \(2^{256} \mathtt{sha256}(x) + \mathtt{sha256}(x+1)\) for
\(x = r, r+2, r+4, \ldots\) is scanned to find a prime. When a prime is found at
\(x\), then the lower 64 bits of \(\mathtt{sha256}(x+1)\) becomes Alice's secret.
The numbers here are big-endian strings of 32 bytes.
</p>

<p>
\(r\) is <code>os.urandom(16)</code> and unknown, but you get to flip arbitrary bits in it
so once it's known you can set it to whatever you want. You're told how many
steps it took in the above sequence to find a prime (simulating a timing
attack), so finding the original \(r\) bit-by-bit is easy, something like:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #7d7c61; font-weight: bold;">def</span> <span style="color: #9b55c3;">find_next_bit</span><span style="color: #bdbdb3;">(</span>oracle, num_known, bits_known<span style="color: #bdbdb3;">)</span>:
  <span style="color: #fb8512;">next_bit</span> = <span style="color: #6a7550;">0</span>
  <span style="color: #7d7c61; font-weight: bold;">while</span> <span style="color: #6a7550;">True</span>:
    <span style="color: #fb8512;">next_bit</span> = <span style="color: #6a7550;">2</span> * next_bit + <span style="color: #bdbdb3;">(</span><span style="color: #6a7550;">1</span> &lt;&lt; num_known<span style="color: #bdbdb3;">)</span>
    <span style="color: #fb8512;">x</span> = oracle<span style="color: #bdbdb3;">(</span>next_bit - bits_known - <span style="color: #6a7550;">2</span><span style="color: #bdbdb3;">)</span>  <span style="color: #6abd50;"># </span><span style="color: #6aaf50;">fetch ABC1111X</span>
    <span style="color: #6abd50;"># </span><span style="color: #6aaf50;">if unlucky</span>
    <span style="color: #7d7c61; font-weight: bold;">if</span> x != <span style="color: #6a7550;">0</span>:
      <span style="color: #7d7c61; font-weight: bold;">break</span>
  <span style="color: #fb8512;">y</span> = oracle<span style="color: #bdbdb3;">(</span>next_bit + bits_known<span style="color: #bdbdb3;">)</span>        <span style="color: #6abd50;"># </span><span style="color: #6aaf50;">fetch ABx0000X</span>

  <span style="color: #6abd50;"># </span><span style="color: #6aaf50;">if C was 0, then oracle(y) fetched at offset +2 closer to the prime</span>
  <span style="color: #6abd50;"># </span><span style="color: #6aaf50;">if C was 1, there's a tiny chance for false positive</span>
  <span style="color: #7d7c61; font-weight: bold;">return</span> y != x - <span style="color: #6a7550;">1</span>
</pre>
</div>

<p>
(Could be made a lot more efficient by making use of past ranges. Probably only
\(1 + \epsilon\) queries is needed for most bits instead of fixed 2 I'm doing
here?)
</p>

<p>
But anyway, this basically solves the task, because now you get the prime,
Alice's secret, and Bob's public key is given.
</p>
</div>
</div>

<div id="outline-container-org6db8c77" class="outline-3">
<h3 id="org6db8c77">babykok</h3>
<div class="outline-text-3" id="text-org6db8c77">
<p>
I'm a closeted Haskell advocate, I've played with other dependent type things
like Agda 2, and there's some community overlap, so I recognized it
immediately. However.
</p>

<p>
I've never used Coq before. I've never used it before, but I now know that I
hate it. I hate its syntax, its IDE, its logo, I hate all the people who think
making puns on its name is smirk-worthy, and the people who pretend the name
doesn't lend itself to puns. I hate how all the blogs make proving stupid toy
theorems about Peano numbers seem like a fun adventure. I hate myself.
</p>

<p>
I have renewed understanding for beginners when they do stuff like:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #7d7c61; font-weight: bold;">if</span> i == <span style="color: #6a7550;">0</span>:
  <span style="color: #fb8512;">s</span> = <span style="color: #CC5542;">"a"</span>
<span style="color: #7d7c61; font-weight: bold;">elif</span> i == <span style="color: #6a7550;">2</span>:
  <span style="color: #fb8512;">s</span> = <span style="color: #CC5542;">"b"</span>
<span style="color: #7d7c61; font-weight: bold;">elif</span> i == <span style="color: #6a7550;">3</span>:
  <span style="color: #fb8512;">s</span> = <span style="color: #CC5542;">"c"</span>
<span style="color: #7d7c61; font-weight: bold;">elif</span> ...
</pre>
</div>

<p>
or
</p>

<div class="org-src-container">
<pre class="src src-python">log<span style="color: #bdbdb3;">(</span><span style="color: #CC5542;">"initializing"</span><span style="color: #bdbdb3;">)</span>
<span style="color: #bdbdb3; font-weight: bold;">sum</span> = <span style="color: #fb8512;">i</span> = <span style="color: #6a7550;">0</span>
<span style="color: #7d7c61; font-weight: bold;">for</span> _ <span style="color: #7d7c61; font-weight: bold;">in</span> <span style="color: #bdbdb3; font-weight: bold;">range</span><span style="color: #bdbdb3;">(</span><span style="color: #6a7550;">100000</span><span style="color: #bdbdb3;">)</span>:
  log<span style="color: #bdbdb3;">(</span><span style="color: #CC5542;">"increasing the index"</span><span style="color: #bdbdb3;">)</span>
  <span style="color: #fb8512;">i</span> += <span style="color: #6a7550;">1</span>
  log<span style="color: #bdbdb3;">(</span><span style="color: #CC5542;">"accumulating sum..."</span><span style="color: #bdbdb3;">)</span>
  <span style="color: #bdbdb3; font-weight: bold;">sum</span> += <span style="color: #6a7550;">17</span> * av<span style="color: #bdbdb3;">[</span>i<span style="color: #bdbdb3;">]</span>**<span style="color: #6a7550;">2</span> + V<span style="color: #bdbdb3;">[</span><span style="color: #6a7550;">2</span>*i + av<span style="color: #6a9550;">[</span>i<span style="color: #6a9550;">]</span>%<span style="color: #6a7550;">2</span><span style="color: #bdbdb3;">]</span>

log<span style="color: #bdbdb3;">(</span><span style="color: #CC5542;">"solving langlands"</span><span style="color: #bdbdb3;">)</span>
solve_langlands<span style="color: #bdbdb3;">()</span>

log<span style="color: #bdbdb3;">(</span><span style="color: #CC5542;">"printing sum"</span><span style="color: #bdbdb3;">)</span>
<span style="color: #7d7c61; font-weight: bold;">print</span><span style="color: #bdbdb3;">(</span><span style="color: #bdbdb3; font-weight: bold;">sum</span><span style="color: #bdbdb3;">)</span>
</pre>
</div>

<p>
I get it. That's me in Coq.
</p>

<p>
I solved the trivial ones easily. The <code>math_theorem</code> one I just pulled from some
tutorial thing. (Super unrewarding way to solve it, but there you go.) I was
stuck on the last problem for a long time, reading tutorials, blog posts,
looking at other proofs, and so on. I also infected <code>poiko</code> and made him waste
time on it. Both of us wasted several combined hours trying to learn Coq's
syntax and usage for this dumb, pseudo-trivial theorem.
</p>

<p>
In the end we both came up with different proofs for the final theorem at
nearly the same time. Mine was:
</p>

<div class="org-src-container">
<pre class="src src-coq">intro n. intro l. revert n. induction l as [|? ? IHl]; intro n; destruct n; simpl.
- intro. apply PeanoNat.Nat.nlt_0_r in H. contradiction.
- intro. apply PeanoNat.Nat.nlt_0_r in H. contradiction.
- destruct 1. exists a. auto. exists a. auto.
- auto with arith.
</pre>
</div>

<p>
It probably makes no sense and looks ridiculous to anyone who knows anything
about Coq.
</p>

<p>
<code>poiko</code>'s solution might make more sense (I couldn't tell):
</p>

<div class="org-src-container">
<pre class="src src-coq">unfold lt; intro n; induction n as [| n hn]; intro l.
- destruct l; simpl. inversion 1. inversion 1. exists a. auto. exists a. auto.
- destruct l. simpl. * inversion 1. * intros. apply hn. auto with arith.
</pre>
</div>

<p>
I'm having a hard time deciding whether this is a good task or not. I mean it
made me despise Coq, that's not good; I'm usually all for ivory tower type
theory stuff. On the one hand, motivating CTF players to learn some
higher-order type theory and theorem proving sounds great, but on the other
hand it feels very arbitrary and polarizing the way this task was put together,
like putting up a poem in Finnish that tells you how to make the flag through
puns&#x2013;free points for anyone who speaks the language, a frustrating Google
hammer experience for the rest.
</p>
</div>
</div>

<div id="outline-container-orgd34d048" class="outline-3">
<h3 id="orgd34d048">Bit Flip 2 &amp; 3</h3>
<div class="outline-text-3" id="text-orgd34d048">
<p>
Similar to <i>Bit Flip 1</i> but Bob's key isn't printed. This ruins the easy
solution. You can still reverse \(r\) as above, so you get a little bit of
control over what the prime becomes as well as Alice's secret, both of which
are of course known, but there's not much else to do.
</p>

<p>
These tasks had me super puzzled. Here's just various notes I made to myself
mentally.
</p>

<p>
The brute forcing options included:
</p>

<ul class="org-ul">
<li>Brute force Bob's 64-bit secret. Nope, not gonna happen.</li>
<li>Brute force hashes to make Alice's secret 0 like a 64-bit PoW task. Also not
gonna happen.</li>
<li>Search the SHA256-stream for primes under which 5 (the generator used) has a
very low order, for example by making \(p-1\) smooth. Given that <i>Bit Flip 3</i>
is just like <i>Bit Flip 2</i> but with the added constraint of strong primes, it
seemed to heavily suggest this was the path. But finding smooth numbers of
this size without sieving you control is near impossible. So this was also
not gonna happen.</li>
</ul>

<p>
I wondered about the <code>(p % 5 == 4)</code> chech in <i>Bit Flip 3</i> &#x2013; like are there any
other constraints for <i>random</i> primes where a given number such as 5 might have
low order in the associated field?
</p>

<p>
The task also specifically imports <code>is_prime()</code> from <code>gmpy2</code>, even though it
uses <code>Crypto.Util.numbers</code> (which has <code>isPrime()</code>). It's the only thing it uses
from <code>gmpy2</code> too. That was curious, but I thought it was just some author
idiosyncracy. Besides, you can't really <i>construct</i> the primes being generated,
you can only pick one from some set of random ones, so again it's not like you
can even begin to think about fooling a standard prime check.
</p>

<p>
All tasks also xors the shared secret with 1337 for seemingly no reason. No
idea why. The shared secret will in "almost all" cases be a 500+ bit number, of
which the 128 most significant bits are used, so it doesn't matter. (Addendum:
I was wrong here, I totally missed the "bug" in <i>Bit Flip 3</i>.)
</p>

<p>
IV isn't reused, there doesn't seem to be a meet-in-the-middle, data collection
probably doesn't help.
</p>

<p>
I failed to even find the <i>problem</i> I was supposed to work on, so I just put it
out of my mind.
</p>

<p>
<i>Post-CTF Addendum:</i> after the CTF ended I found out that <i>Bit Flip 3</i> can be
solved trivially because <code>long_to_bytes(x, 16)</code> does something quite
unexpected:
</p>

<div class="org-src-container">
<pre class="src src-python">&gt;&gt;&gt; long_to_bytes<span style="color: #bdbdb3;">(</span>random.getrandbits<span style="color: #6a9550;">(</span><span style="color: #6a7550;">513</span><span style="color: #6a9550;">)</span>, <span style="color: #6a7550;">16</span><span style="color: #bdbdb3;">)[</span>:<span style="color: #6a7550;">16</span><span style="color: #bdbdb3;">]</span>
b<span style="color: #6a9550;">'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01'</span>
</pre>
</div>

<p>
This was actually really clever! Ever since I started joining CTFs I've had a
low-key distaste for <code>long_to_bytes()</code> and how pervasive it is. It feels so
Python 2-y. It's in every crypto task under the sun, so its usage didn't stand
out to me at all, and I never bothered to check up on it in this case. I'm
sorry I missed this a-ha moment. Deceptive!
</p>

<p>
However it seems that several people solved <i>Bit Flip 2</i> by "brute force the
hashes modulo OSINT." Namely: the BitCoin blockchain has a lot of such hashes,
so you can find hashes there that match the requirements. Although that's a
clever idea, it sort of lowers the task in my estimation greatly if that is the
intended solution. It's just a really unfun way to solve problems. It feels a
lot like "enter the MD5 hash in Google" or "look up the factors on
factordb.com" but version 2.0. Big boy OSINT is still OSINT. If anyone has a
programmatic or mathematical solution to <i>Bit Flip 2</i> that doesn't look up
dirty money-laundered power-guzzling hashes from other sources I'm very
interested to see what I missed?
</p>

<p>
Not that anyone reads these notes, but hey.
</p>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
by "puzzles" I mean problems that have a <i>natural</i> translation into
mathematics and reveal there a certain simplicity and elegance in generalized
form. It stands in marked contrast to "riddles"<sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup>, which tend to resist
mathematical patterns, and are usually dependent on culture, language, or
specific trivia.
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara"><p class="footpara">
I am pretty bad at escape-room CTFs where you hold up the message under a
full moon to reveal a bunch of points that turn out to align with certain zodiac
signs in the sky, and then after translating the zodiacs into numbers using the
provided plastic spy-codex, you get a number which turns out to be the Dewey
decimal index where you can find the book that was used for the book cipher.
(See <a href="https://masrt200.github.io/hacker-blog/hacktober-ctf">example</a>.) That kind of Sherlock Holmes stuff is completely orthogonal with
the kind of puzzles I enjoy.
</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3">3</a></sup> <div class="footpara"><p class="footpara">
Given appropriate adjustment of over-rated CTFs that feature stego and
guess-tasks.
</p></div></div>

<div class="footdef"><sup><a id="fn.4" class="footnum" href="#fnr.4">4</a></sup> <div class="footpara"><p class="footpara">
I firmly believe the inventors of PHP ought to be retroactively
punished for having made the world a worse place. Every time I had to read a PHP
doc page and look at the comments by PHP users I could feel myself losing IQ
points as if breathing in neurotoxic mold.
</p></div></div>

<div class="footdef"><sup><a id="fn.5" class="footnum" href="#fnr.5">5</a></sup> <div class="footpara"><p class="footpara">
We're only a two-man team, so naturally we don't stand a chance for a
competitive placement, but it was a lot of fun with good, challenging tasks.
</p></div></div>

<div class="footdef"><sup><a id="fn.6" class="footnum" href="#fnr.6">6</a></sup> <div class="footpara"><p class="footpara">
Maybe I'm only critical because I'm embarrassed it fooled me!
</p></div></div>

<div class="footdef"><sup><a id="fn.7" class="footnum" href="#fnr.7">7</a></sup> <div class="footpara"><p class="footpara">
which is fine, but it could have been a sub-problem in another task for
example. One could also say it tries to teach you some math&#x2013;but it's the sort
of stuff with a trivial Sage/Google escape hatch. The trademark of low-effort
tasks that get ground up by the "point mill" into bland paste, rather than
offering any fun/engaging problem solving.
</p></div></div>

<div class="footdef"><sup><a id="fn.8" class="footnum" href="#fnr.8">8</a></sup> <div class="footpara"><p class="footpara">
Also: this was my first impression: <code>#!/usr/bin/env python2</code>. <code>:shudder:</code> This has nothing to do with the
task itself, but it always makes my heart sink and I lose a bit of faith in the
problem author and the world in general.
</p></div></div>

<div class="footdef"><sup><a id="fn.9" class="footnum" href="#fnr.9">9</a></sup> <div class="footpara"><p class="footpara">
The question "why <i>is</i> JavaScript?" is ostensibly answered with "because
fuck you, because we're engineers and we get the job done, that's why." But the
question "why is JavaScript <i>the way it is</i>?" can only be answered with a shrug
and an embarrassed silence. Indeed, why is any scatological piece of art the way
it is.
</p></div></div>

<div class="footdef"><sup><a id="fn.10" class="footnum" href="#fnr.10">10</a></sup> <div class="footpara"><p class="footpara">
OK, actually the fact that it uses T-tables probably helps, as
high-weight input will likely lead to high-weight output from the lookups there?
I don't know, I've never done any power-analysis before.
</p></div></div>

<div class="footdef"><sup><a id="fn.11" class="footnum" href="#fnr.11">11</a></sup> <div class="footpara"><p class="footpara">
I was assuming the wrong byte length of course, because it wasn't HMAC,
nor was it plain CRC(x), but it was salted. And I hadn't figured out the
byte-length independent approach.
</p></div></div>

<div class="footdef"><sup><a id="fn.12" class="footnum" href="#fnr.12">12</a></sup> <div class="footpara"><p class="footpara">
I suspect <code>Show your Patience and Intelligence I</code> is another one, but
since I only partially solved it, I couldn't really say outright. See also
<a href="https://github.com/BookGin/my-ctf-challenges/tree/master/balsn-ctf-2019/images-and-words">https://github.com/BookGin/my-ctf-challenges/tree/master/balsn-ctf-2019/images-and-words</a>
from last year's BalsnCTF, which&#x2013;don't get me wrong&#x2013;is a really cool and
mind-blowing task, but you need three fairly independent key insights to solve
it. Although I guess in web this kind of stuff is more like the standard way of
doing things?
</p></div></div>

<div class="footdef"><sup><a id="fn.13" class="footnum" href="#fnr.13">13</a></sup> <div class="footpara"><p class="footpara">
because the domain knowledge required for the entire thing grows
linearly with unrelated sub-tasks added. This is another reason why I don't like
mixed challenges. Crypto behind web, misc behind rev, etc. It feels like a sort
of "miserly" way of forcing the solve count to stay low even though the subtasks
are themselves easy or unoriginal. Generalists and people with "broad"
CTF-knowledge are already greatly rewarded and have a (fair!) advantage over
more specialized noobs (like me), but this doubles down on that advantage on the
task level.
</p></div></div>

<div class="footdef"><sup><a id="fn.14" class="footnum" href="#fnr.14">14</a></sup> <div class="footpara"><p class="footpara">
Norwegian for 'field'
</p></div></div>

<div class="footdef"><sup><a id="fn.15" class="footnum" href="#fnr.15">15</a></sup> <div class="footpara"><p class="footpara">
I say I lucked out because my <code>sage</code> seems to hit a bug when I do
<code>A.multiplicative_order()</code> directly. It just hangs and churns CPU for over a
minute, so most likely I would have given up on this avenue. Who knows why
<code>sage</code> does what it does sometimes. <code>:its_a_mystery:</code>
</p></div></div>

<div class="footdef"><sup><a id="fn.16" class="footnum" href="#fnr.16">16</a></sup> <div class="footpara"><p class="footpara">
looking up on OEIS felt like cheating but it saved a couple of minutes.
It's clear in hindsight, as the list goes: A, B, BAAA, BAAABBB,
BAAABBBBAAABAAABAAA and so on.
</p></div></div>

<div class="footdef"><sup><a id="fn.17" class="footnum" href="#fnr.17">17</a></sup> <div class="footpara"><p class="footpara">
There's only two hard problems in computer science: naming things, cache
invalidation, and off-by-one errors. (Recycled Twitter joke.)
</p></div></div>


</div>
</div></div>
</body>
</html>
